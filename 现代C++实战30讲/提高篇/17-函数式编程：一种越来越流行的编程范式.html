<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>17-å‡½æ•°å¼ç¼–ç¨‹ï¼šä¸€ç§è¶Šæ¥è¶Šæµè¡Œçš„ç¼–ç¨‹èŒƒå¼</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <style>
        html {
            color: #333;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-rendering: optimizelegibility;
            font-family: Helvetica Neue, PingFang SC, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif
        }

        html.borderbox *,
        html.borderbox :after,
        html.borderbox :before {
            box-sizing: border-box
        }

        article,
        aside,
        blockquote,
        body,
        button,
        code,
        dd,
        details,
        dl,
        dt,
        fieldset,
        figcaption,
        figure,
        footer,
        form,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        header,
        hr,
        input,
        legend,
        li,
        menu,
        nav,
        ol,
        p,
        pre,
        section,
        td,
        textarea,
        th,
        ul {
            margin: 0;
            padding: 0
        }

        article,
        aside,
        details,
        figcaption,
        figure,
        footer,
        header,
        menu,
        nav,
        section {
            display: block
        }

        audio,
        canvas,
        video {
            display: inline-block
        }

        body,
        button,
        input,
        select,
        textarea {
            font: 300 1em/1.8 PingFang SC, Lantinghei SC, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, Helvetica, sans-serif
        }

        button::-moz-focus-inner,
        input::-moz-focus-inner {
            padding: 0;
            border: 0
        }

        table {
            border-collapse: collapse;
            border-spacing: 0
        }

        fieldset,
        img {
            border: 0
        }

        blockquote {
            position: relative;
            color: #999;
            font-weight: 400;
            border-left: 1px solid #1abc9c;
            padding-left: 1em;
            margin: 1em 3em 1em 2em
        }

        @media only screen and (max-width: 640px) {
            blockquote {
                margin: 1em 0
            }
        }

        abbr,
        acronym {
            border-bottom: 1px dotted;
            font-variant: normal
        }

        abbr {
            cursor: help
        }

        del {
            text-decoration: line-through
        }

        address,
        caption,
        cite,
        code,
        dfn,
        em,
        th,
        var {
            font-style: normal;
            font-weight: 400
        }

        ol,
        ul {
            list-style: none
        }

        caption,
        th {
            text-align: left
        }

        q:after,
        q:before {
            content: ""
        }

        sub,
        sup {
            font-size: 75%;
            line-height: 0;
            position: relative
        }

        :root sub,
        :root sup {
            vertical-align: baseline
        }

        sup {
            top: -.5em
        }

        sub {
            bottom: -.25em
        }

        a {
            color: #1abc9c
        }

        a:hover {
            text-decoration: underline
        }

        .typo a {
            border-bottom: 1px solid #1abc9c
        }

        .typo a:hover {
            border-bottom-color: #555;
            color: #555
        }

        .typo a:hover,
        a,
        ins {
            text-decoration: none
        }

        .typo-u,
        u {
            text-decoration: underline
        }

        mark {
            background: #fffdd1;
            border-bottom: 1px solid #ffedce;
            padding: 2px;
            margin: 0 5px
        }

        code,
        pre,
        pre tt {
            font-family: Courier, Courier New, monospace
        }

        pre {
            background: hsla(0, 0%, 97%, .7);
            border: 1px solid #ddd;
            padding: 1em 1.5em;
            display: block;
            -webkit-overflow-scrolling: touch
        }

        hr {
            border: none;
            border-bottom: 1px solid #cfcfcf;
            margin-bottom: .8em;
            height: 10px
        }

        .typo-small,
        figcaption,
        small {
            font-size: .9em;
            color: #888
        }

        b,
        strong {
            font-weight: 700;
            color: #000
        }

        [draggable] {
            cursor: move
        }

        .clearfix:after,
        .clearfix:before {
            content: "";
            display: table
        }

        .clearfix:after {
            clear: both
        }

        .clearfix {
            zoom: 1
        }

        .textwrap,
        .textwrap td,
        .textwrap th {
            word-wrap: break-word;
            word-break: break-all
        }

        .textwrap-table {
            table-layout: fixed
        }

        .serif {
            font-family: Palatino, Optima, Georgia, serif
        }

        .typo-dl,
        .typo-form,
        .typo-hr,
        .typo-ol,
        .typo-p,
        .typo-pre,
        .typo-table,
        .typo-ul,
        .typo dl,
        .typo form,
        .typo hr,
        .typo ol,
        .typo p,
        .typo pre,
        .typo table,
        .typo ul,
        blockquote {
            margin-bottom: 1rem
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: PingFang SC, Helvetica Neue, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif;
            color: #000;
            line-height: 1.35
        }

        .typo-h1,
        .typo-h2,
        .typo-h3,
        .typo-h4,
        .typo-h5,
        .typo-h6,
        .typo h1,
        .typo h2,
        .typo h3,
        .typo h4,
        .typo h5,
        .typo h6 {
            margin-top: 1.2em;
            margin-bottom: .6em;
            line-height: 1.35
        }

        .typo-h1,
        .typo h1 {
            font-size: 2em
        }

        .typo-h2,
        .typo h2 {
            font-size: 1.8em
        }

        .typo-h3,
        .typo h3 {
            font-size: 1.6em
        }

        .typo-h4,
        .typo h4 {
            font-size: 1.4em
        }

        .typo-h5,
        .typo-h6,
        .typo h5,
        .typo h6 {
            font-size: 1.2em
        }

        .typo-ul,
        .typo ul {
            margin-left: 1.3em;
            list-style: disc
        }

        .typo-ol,
        .typo ol {
            list-style: decimal;
            margin-left: 1.9em
        }

        .typo-ol ol,
        .typo-ol ul,
        .typo-ul ol,
        .typo-ul ul,
        .typo li ol,
        .typo li ul {
            margin-bottom: .8em;
            margin-left: 2em
        }

        .typo-ol ul,
        .typo-ul ul,
        .typo li ul {
            list-style: circle
        }

        .typo-table td,
        .typo-table th,
        .typo table caption,
        .typo table td,
        .typo table th {
            border: 1px solid #ddd;
            padding: .5em 1em;
            color: #666
        }

        .typo-table th,
        .typo table th {
            background: #fbfbfb
        }

        .typo-table thead th,
        .typo table thead th {
            background: hsla(0, 0%, 95%, .7)
        }

        .typo table caption {
            border-bottom: none
        }

        .typo-input,
        .typo-textarea {
            -webkit-appearance: none;
            border-radius: 0
        }

        .typo-em,
        .typo em,
        caption,
        legend {
            color: #000;
            font-weight: inherit
        }

        .typo-em {
            position: relative
        }

        .typo-em:after {
            position: absolute;
            top: .65em;
            left: 0;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            content: "\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB"
        }

        .typo img {
            max-width: 100%
        }

        .common-content {
            font-weight: 400;
            color: #353535;
            line-height: 1.75rem;
            white-space: normal;
            word-break: normal;
            font-size: 1rem
        }

        .common-content img {
            display: block;
            max-width: 100%;
            background-color: #eee
        }

        .common-content audio,
        .common-content video {
            width: 100%;
            background-color: #eee
        }

        .common-content center,
        .common-content font {
            margin-top: 1rem;
            display: inline-block
        }

        .common-content center {
            width: 100%
        }

        .common-content pre {
            margin-top: 1rem;
            padding-left: 0;
            padding-right: 0;
            position: relative;
            overflow: hidden
        }

        .common-content pre code {
            font-size: .8rem;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding-left: 1rem;
            padding-right: 1rem;
            overflow-x: auto
        }

        .common-content hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        .common-content b,
        .common-content h1,
        .common-content h2,
        .common-content h3,
        .common-content h4,
        .common-content h5,
        .common-content strong {
            font-weight: 700
        }

        .common-content h1,
        .common-content h2 {
            font-size: 1.125rem;
            margin-bottom: .45rem
        }

        .common-content h3,
        .common-content h4,
        .common-content h5 {
            font-size: 1rem;
            margin-bottom: .45rem
        }

        .common-content p {
            font-weight: 400;
            color: #353535;
            margin-top: .15rem
        }

        .common-content .orange {
            color: #ff5a05
        }

        .common-content .reference {
            font-size: 1rem;
            color: #888
        }

        .custom-rich-content h1 {
            margin-top: 0;
            font-weight: 400;
            font-size: 15.25px;
            border-bottom: 1px solid #eee;
            line-height: 2.8
        }

        .custom-rich-content li,
        .custom-rich-content p {
            font-size: 14px;
            color: #888;
            line-height: 1.6
        }

        table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        table.hljs-ln,
        table.hljs-ln tbody,
        table.hljs-ln td,
        table.hljs-ln tr {
            box-sizing: border-box
        }

        table.hljs-ln td {
            padding: 0;
            border: 0
        }

        table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            user-select: none
        }

        table.hljs-ln td.hljs-ln-code,
        table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            font-size: 12px;
            line-height: 20px;
            vertical-align: top
        }

        table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            color: #24292e;
            word-wrap: normal;
            white-space: pre
        }

        video::-webkit-media-controls {
            overflow: hidden !important
        }

        video::-webkit-media-controls-enclosure {
            width: calc(100% + 32px);
            margin-left: auto
        }

        ._29HP61GA_0 {
            max-width:800px;
            margin:0 auto;
            margin-bottom: 20px;
            font-weight: 400;
            color: #353535;
            line-height: 1.76;
            white-space: normal;
            word-break: normal;
            font-size: 17px;
            -webkit-transition: background-color .3s ease;
            transition: background-color .3s ease
        }

        ._29HP61GA_0 .MathJax_Display {
            overflow: auto
        }

        ._29HP61GA_0 .poster {
            position: fixed;
            left: -10000px;
            top: -10000px;
            overflow: hidden;
            padding: 1rem;
            background: #ececec
        }

        ._29HP61GA_0 .richcontent-pre-copy {
            font-size: 13px;
            color: #888;
            position: absolute;
            right: 1em;
            top: .5em;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 .richcontent-pre-copy .iconfont {
            font-size: 12px;
            margin-right: .2em
        }

        ._29HP61GA_0 a {
            color: #fa8919;
            border-bottom: 1px solid #fa8919
        }

        ._29HP61GA_0 img {
            display: block;
            max-width: 100%;
            position: relative;
            left: 50%;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            background-color: #eee;
            vertical-align: top;
            border-radius: 0
        }

        ._29HP61GA_0 audio,
        ._29HP61GA_0 video {
            width: 100%;
            background-color: #eee
        }

        ._29HP61GA_0 pre {
            margin-top: 16px;
            padding: 34px 0 0;
            margin-bottom: 30px;
            position: relative;
            border-radius: 6px;
            background: rgba(246, 247, 251, .749);
            border: 0
        }

        ._29HP61GA_0 pre code {
            font-size: 12px;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            margin-left: 16px;
            margin-right: 16px;
            overflow-x: scroll
        }

        ._29HP61GA_0 pre code:after {
            content: "";
            height: 30px;
            width: 100%;
            display: block
        }

        ._29HP61GA_0 hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        ._29HP61GA_0 h1,
        ._29HP61GA_0 h2,
        ._29HP61GA_0 h3,
        ._29HP61GA_0 h4,
        ._29HP61GA_0 h5 {
            margin-bottom: 20px;
            margin-top: 0;
            font-weight: 700
        }

        ._29HP61GA_0 b,
        ._29HP61GA_0 strong {
            font-weight: 700
        }

        ._29HP61GA_0 h1 {
            font-size: 21px
        }

        ._29HP61GA_0 h2 {
            font-size: 20px
        }

        ._29HP61GA_0 h3 {
            font-size: 19px
        }

        ._29HP61GA_0 h4 {
            font-size: 18px
        }

        ._29HP61GA_0 h5 {
            font-size: 17px
        }

        ._29HP61GA_0 center,
        ._29HP61GA_0 p {
            font-weight: 400;
            color: #353535;
            margin-top: 0;
            margin-bottom: 30px;
            word-break: break-word
        }

        ._29HP61GA_0 center {
            text-align: center
        }

        ._29HP61GA_0 blockquote {
            margin-top: 0;
            margin-bottom: 34px;
            border-left: 3px solid #e8e8e8;
            padding-left: 17px;
            color: #353535
        }

        ._29HP61GA_0 blockquote p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol,
        ._29HP61GA_0 ul {
            margin-bottom: 30px
        }

        ._29HP61GA_0 ol p,
        ._29HP61GA_0 ul p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol {
            list-style: decimal;
            margin-left: 20px
        }

        ._29HP61GA_0 ul li {
            padding-left: 17px;
            position: relative;
            margin-bottom: 10px
        }

        ._29HP61GA_0 ul li:after {
            content: "";
            height: 6px;
            width: 6px;
            border-radius: 50%;
            background: #353535;
            position: absolute;
            top: 10px;
            left: 0
        }

        ._29HP61GA_0 .orange {
            color: #fa8919
        }

        ._29HP61GA_0 .reference {
            color: #888
        }

        ._29HP61GA_0 .m-right {
            text-align: right
        }

        ._29HP61GA_0 .m-center {
            text-align: center;
            display: block
        }

        ._29HP61GA_0 .m-gray {
            color: #888
        }

        ._29HP61GA_0 .m-small {
            font-size: 15px
        }

        ._29HP61GA_0 table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        ._29HP61GA_0 table.hljs-ln,
        ._29HP61GA_0 table.hljs-ln tbody,
        ._29HP61GA_0 table.hljs-ln td,
        ._29HP61GA_0 table.hljs-ln tr {
            -webkit-box-sizing: border-box;
            box-sizing: border-box
        }

        ._29HP61GA_0 table.hljs-ln td {
            padding: 0;
            border: 0
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            font-size: 12px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code,
        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            line-height: 20px;
            vertical-align: top
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            font-size: 13px;
            color: #666;
            word-wrap: normal;
            white-space: pre
        }

    </style>
</head>
<body>
<div class="_29HP61GA_0">
<h1>17-å‡½æ•°å¼ç¼–ç¨‹ï¼šä¸€ç§è¶Šæ¥è¶Šæµè¡Œçš„ç¼–ç¨‹èŒƒå¼</h1>
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å´å’ç‚œã€‚</p><p>ä¸Šä¸€è®²æˆ‘ä»¬åˆæ­¥ä»‹ç»äº†å‡½æ•°å¯¹è±¡å’Œ lambda è¡¨è¾¾å¼ï¼Œä»Šå¤©æˆ‘ä»¬æ¥è®²è®²å®ƒä»¬çš„ä¸»è¦ç”¨é€”â€”â€”å‡½æ•°å¼ç¼–ç¨‹ã€‚</p><h2>ä¸€ä¸ªå°ä¾‹å­</h2><p>æŒ‰æƒ¯ä¾‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä»ä¸€ä¸ªä¾‹å­å¼€å§‹ã€‚æƒ³ä¸€ä¸‹ï¼Œå¦‚æœç»™å®šä¸€ç»„æ–‡ä»¶åï¼Œè¦æ±‚æ•°ä¸€ä¸‹æ–‡ä»¶é‡Œçš„æ€»æ–‡æœ¬è¡Œæ•°ï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿ</p><p>æˆ‘ä»¬å…ˆè§„å®šä¸€ä¸‹å‡½æ•°çš„åŸå‹ï¼š</p><pre><code class="language-c++">int count_lines(const char** begin,
                const char** end);
</code></pre><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æœŸå¾…æ¥å—ä¸¤ä¸ª C å­—ç¬¦ä¸²çš„è¿­ä»£å™¨ï¼Œç”¨æ¥éå†æ‰€æœ‰çš„æ–‡ä»¶åï¼›è¿”å›å€¼ä»£è¡¨æ–‡ä»¶ä¸­çš„æ€»è¡Œæ•°ã€‚</p><p>è¦æµ‹è¯•è¡Œä¸ºæ˜¯å¦æ­£å¸¸ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¾ˆå°çš„ <code>main</code> å‡½æ•°ï¼š</p><pre><code class="language-c++">int main(int argc,
         const char** argv)
{
  int total_lines = count_lines(
    argv + 1, argv + argc);
  cout &lt;&lt; "Total lines: "
       &lt;&lt; total_lines &lt;&lt; endl;
}
</code></pre><p>æœ€ä¼ ç»Ÿçš„å‘½ä»¤å¼ç¼–ç¨‹å¤§æ¦‚ä¼šè¿™æ ·å†™ä»£ç ï¼š</p><pre><code class="language-c++">int count_file(const char* name)
{
  int count = 0;
  ifstream ifs(name);
  string line;
  for (;;) {
    getline(ifs, line);
    if (!ifs) {
      break;
    }
    ++count;
  }
  return count;
}

int count_lines(const char** begin,
                const char** end)
{
  int count = 0;
  for (; begin != end; ++begin) {
    count += count_file(*begin);
  }
  return count;
}
</code></pre><!-- [[[read_end]]] --><p>æˆ‘ä»¬é©¬ä¸Šå¯ä»¥åšä¸€ä¸ªç®€å•çš„â€œè¯´æ˜å¼â€æ”¹é€ ã€‚ç”¨ <code>istream_line_reader</code> å¯ä»¥ç®€åŒ– <code>count_file</code> æˆï¼š</p><pre><code class="language-c++">int count_file(const char* name)
{
  int count = 0;
  ifstream ifs(name);
  for (auto&amp;&amp; line :
       istream_line_reader(ifs)) {
    ++count;
  }
  return count;
}
</code></pre><p>åœ¨è¿™å„¿ï¼Œè¦è¯·ä½ åœä¸€ä¸‹ï¼Œæƒ³ä¸€æƒ³å¦‚ä½•è¿›ä¸€æ­¥ä¼˜åŒ–è¿™ä¸ªä»£ç ã€‚ç„¶åå†ç»§ç»­è¿›è¡Œå¾€ä¸‹çœ‹ã€‚</p><hr></hr><p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¹‹å‰å·²ç»å‡ºåœºè¿‡çš„ä¸¤ä¸ªå‡½æ•°ï¼Œ<code>transform</code> <span class="orange">[1]</span> å’Œ <code>accumulate</code> <span class="orange">[2]</span>ï¼Œä»£ç å¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–ä¸ºï¼š</p><pre><code class="language-c++">int count_file(const char* name)
{
  ifstream ifs(name);
  istream_line_reader reader(ifs);
  return distance(reader.begin(),
                  reader.end());
}

int count_lines(const char** begin,
                const char** end)
{
  vector&lt;int&gt; count(end - begin);
  transform(begin, end,
            count.begin(),
            count_file);
  return accumulate(
    count.begin(), count.end(),
    0);
}
</code></pre><p>è¿™ä¸ªå°±æ˜¯ä¸€ä¸ªéå¸¸å‡½æ•°å¼é£æ ¼çš„ç»“æœäº†ã€‚ä¸Šé¢è¿™ä¸ªå¤„ç†æ–¹å¼æ°æ°å°±æ˜¯ map-reduceã€‚<code>transform</code> å¯¹åº” mapï¼Œ<code>accumulate</code> å¯¹åº” reduceã€‚è€Œæ£€æŸ¥æœ‰å¤šå°‘è¡Œæ–‡æœ¬ï¼Œä¹Ÿæˆäº†ä»£è¡¨æ–‡ä»¶å¤´å°¾ä¸¤ä¸ªè¿­ä»£å™¨ä¹‹é—´çš„â€œè·ç¦»â€ï¼ˆdistanceï¼‰ã€‚</p><h2>å‡½æ•°å¼ç¼–ç¨‹çš„ç‰¹ç‚¹</h2><p>åœ¨æˆ‘ä»¬çš„ä»£ç é‡Œä¸é‚£ä¹ˆæ˜æ˜¾çš„ä¸€ç‚¹æ˜¯ï¼Œå‡½æ•°å¼ç¼–ç¨‹æœŸæœ›å‡½æ•°çš„è¡Œä¸ºåƒæ•°å­¦ä¸Šçš„å‡½æ•°ï¼Œè€Œéä¸€ä¸ªè®¡ç®—æœºä¸Šçš„å­ç¨‹åºã€‚è¿™æ ·çš„å‡½æ•°ä¸€èˆ¬è¢«ç§°ä¸ºçº¯å‡½æ•°ï¼ˆpure functionï¼‰ï¼Œè¦ç‚¹åœ¨äºï¼š</p><ul>
<li>ä¼šå½±å“å‡½æ•°ç»“æœçš„åªæ˜¯å‡½æ•°çš„å‚æ•°ï¼Œæ²¡æœ‰å¯¹ç¯å¢ƒçš„ä¾èµ–</li>
<li>è¿”å›çš„ç»“æœå°±æ˜¯å‡½æ•°æ‰§è¡Œçš„å”¯ä¸€åæœï¼Œä¸äº§ç”Ÿå¯¹ç¯å¢ƒçš„å…¶ä»–å½±å“</li>
</ul><p>è¿™æ ·çš„ä»£ç çš„æœ€å¤§å¥½å¤„æ˜¯æ˜“äºç†è§£å’Œæ˜“äºæ¨ç†ï¼Œåœ¨å¾ˆå¤šæƒ…å†µä¸‹ä¹Ÿä¼šä½¿ä»£ç æ›´ç®€å•ã€‚åœ¨æˆ‘ä»¬ä¸Šé¢çš„ä»£ç é‡Œï¼Œ<code>count_file</code> å’Œ <code>accumulate</code> åŸºæœ¬ä¸Šå¯ä»¥çœ‹åšæ˜¯çº¯å‡½æ•°ï¼ˆè™½ç„¶å‰è€…å®é™…ä¸Šæœ‰ç€å¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä¾èµ–ï¼‰ï¼Œä½† <code>transform</code> ä¸è¡Œï¼Œå› ä¸ºå®ƒæ”¹å˜äº†æŸä¸ªå‚æ•°ï¼Œè€Œä¸æ˜¯è¿”å›ä¸€ä¸ªç»“æœã€‚ä¸‹ä¸€è®²æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œè¿™ä¼šå½±å“ä»£ç çš„ç»„åˆæ€§ã€‚</p><p>æˆ‘ä»¬çš„ä»£ç ä¸­ä¹Ÿä½“ç°äº†å…¶ä»–ä¸€äº›å‡½æ•°å¼ç¼–ç¨‹çš„ç‰¹ç‚¹ï¼š</p><ul>
<li>å‡½æ•°å°±åƒæ™®é€šçš„å¯¹è±¡ä¸€æ ·è¢«ä¼ é€’ã€ä½¿ç”¨å’Œè¿”å›ã€‚</li>
<li>ä»£ç ä¸ºè¯´æ˜å¼è€Œéå‘½ä»¤å¼ã€‚åœ¨ç†Ÿæ‚‰å‡½æ•°å¼ç¼–ç¨‹çš„åŸºæœ¬èŒƒå¼åï¼Œä½ ä¼šå‘ç°è¯´æ˜å¼ä»£ç çš„å¯è¯»æ€§é€šå¸¸æ¯”å‘½ä»¤å¼è¦é«˜ï¼Œä»£ç è¿˜çŸ­ã€‚</li>
<li>ä¸€èˆ¬ä¸é¼“åŠ±ï¼ˆç”šè‡³å®Œå…¨ä¸ä½¿ç”¨ï¼‰å¯å˜é‡ã€‚ä¸Šé¢ä»£ç é‡Œåªæœ‰ <code>count</code> çš„å†…å®¹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«ä¿®æ”¹äº†ï¼Œè€Œä¸”è¿™ç§ä¿®æ”¹å®é™…æ˜¯ <code>transform</code> æ¥å£å¸¦æ¥çš„ã€‚å¦‚æœæ¥å£åƒ <a href="https://time.geekbang.org/column/article/181608">[ç¬¬ 13 è®²]</a> å±•ç¤ºçš„ <code>fmap</code> å‡½æ•°ä¸€æ ·è¿”å›ä¸€ä¸ªå®¹å™¨çš„è¯ï¼Œå°±å¯ä»¥è¿è¿™ä¸ªé—®é¢˜éƒ½æ¶ˆé™¤äº†ã€‚ï¼ˆC++ æ¯•ç«Ÿä¸æ˜¯ä¸€é—¨å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ï¼Œå¯¹çµæ´»æ€§çš„è¿½æ±‚å‹å€’äº†å…¶ä»–è€ƒè™‘ã€‚ï¼‰</li>
</ul><h3>é«˜é˜¶å‡½æ•°</h3><p>æ—¢ç„¶å‡½æ•°ï¼ˆå¯¹è±¡ï¼‰å¯ä»¥è¢«ä¼ é€’ã€ä½¿ç”¨å’Œè¿”å›ï¼Œè‡ªç„¶å°±æœ‰å‡½æ•°ä¼šæ¥å—å‡½æ•°ä½œä¸ºå‚æ•°æˆ–è€…æŠŠå‡½æ•°ä½œä¸ºè¿”å›å€¼ï¼Œè¿™æ ·çš„å‡½æ•°å°±è¢«ç§°ä¸ºé«˜é˜¶å‡½æ•°ã€‚æˆ‘ä»¬ç°åœ¨å·²ç»è§è¿‡ä¸å°‘é«˜é˜¶å‡½æ•°äº†ï¼Œå¦‚ï¼š</p><ul>
<li><code>sort</code></li>
<li><code>transform</code></li>
<li><code>accumulate</code></li>
<li><code>fmap</code></li>
<li><code>adder</code></li>
</ul><p>äº‹å®ä¸Šï¼ŒC++ é‡Œä»¥ algorithmï¼ˆç®—æ³•ï¼‰<span class="orange">[3]</span> åä¹‰æä¾›çš„å¾ˆå¤šå‡½æ•°éƒ½æ˜¯é«˜é˜¶å‡½æ•°ã€‚</p><p>è®¸å¤šé«˜é˜¶å‡½æ•°åœ¨å‡½æ•°å¼ç¼–ç¨‹ä¸­å·²æˆä¸ºåŸºæœ¬çš„æƒ¯ç”¨æ³•ï¼Œåœ¨ä¸åŒè¯­è¨€ä¸­éƒ½ä¼šå‡ºç°ï¼Œè™½ç„¶å¯èƒ½æ˜¯ä»¥ä¸åŒçš„åå­—ã€‚æˆ‘ä»¬åœ¨æ­¤ä»‹ç»éå¸¸å¸¸è§çš„ä¸‰ä¸ªï¼Œmapï¼ˆæ˜ å°„ï¼‰ã€reduceï¼ˆå½’å¹¶ï¼‰å’Œ filterï¼ˆè¿‡æ»¤ï¼‰ã€‚</p><p>Map åœ¨ C++ ä¸­çš„ç›´æ¥æ˜ å°„æ˜¯ <code>transform</code>ï¼ˆåœ¨ &lt;algorithm&gt; å¤´æ–‡ä»¶ä¸­æä¾›ï¼‰ã€‚å®ƒæ‰€åšçš„äº‹æƒ…ä¹Ÿæ˜¯æ•°å­¦ä¸Šçš„æ˜ å°„ï¼ŒæŠŠä¸€ä¸ªèŒƒå›´é‡Œçš„å¯¹è±¡è½¬æ¢æˆç›¸åŒæ•°é‡çš„å¦å¤–ä¸€äº›å¯¹è±¡ã€‚è¿™ä¸ªå‡½æ•°çš„åŸºæœ¬å®ç°éå¸¸ç®€å•ï¼Œä½†è¿™æ˜¯ä¸€ç§å¼ºå¤§çš„æŠ½è±¡ï¼Œåœ¨å¾ˆå¤šåœºåˆéƒ½ç”¨å¾—ä¸Šã€‚</p><p>Reduce åœ¨ C++ ä¸­çš„ç›´æ¥æ˜ å°„æ˜¯ <code>accumulate</code>ï¼ˆåœ¨ &lt;numeric&gt; å¤´æ–‡ä»¶ä¸­æä¾›ï¼‰ã€‚å®ƒçš„åŠŸèƒ½æ˜¯åœ¨æŒ‡å®šçš„èŒƒå›´é‡Œï¼Œä½¿ç”¨ç»™å®šçš„åˆå€¼å’Œå‡½æ•°å¯¹è±¡ï¼Œä»å·¦åˆ°å³å¯¹æ•°å€¼è¿›è¡Œå½’å¹¶ã€‚åœ¨ä¸æä¾›å‡½æ•°å¯¹è±¡ä½œä¸ºç¬¬å››ä¸ªå‚æ•°æ—¶ï¼ŒåŠŸèƒ½ä¸Šç›¸å½“äºé»˜è®¤æä¾›äº†åŠ æ³•å‡½æ•°å¯¹è±¡ï¼›è¿™æ—¶ç›¸å½“äºåšç´¯åŠ ã€‚æä¾›äº†å…¶ä»–å‡½æ•°å¯¹è±¡æ—¶ï¼Œé‚£å½“ç„¶å°±æ˜¯ä½¿ç”¨è¯¥å‡½æ•°å¯¹è±¡è¿›è¡Œå½’å¹¶äº†ã€‚</p><p>Filter çš„åŠŸèƒ½æ˜¯è¿›è¡Œè¿‡æ»¤ï¼Œç­›é€‰å‡ºç¬¦åˆæ¡ä»¶çš„æˆå‘˜ã€‚å®ƒåœ¨å½“å‰ C++ï¼ˆC++20 ä¹‹å‰ï¼‰é‡Œçš„æ˜ å°„å¯ä»¥è®¤ä¸ºæœ‰ä¸¤ä¸ªï¼š<code>copy_if</code> å’Œ <code>partition</code>ã€‚è¿™æ˜¯å› ä¸ºåœ¨ C++20 å¸¦æ¥ ranges ä¹‹å‰ï¼Œåœ¨ C++ é‡Œå®ç°æƒ°æ€§æ±‚å€¼ä¸å¤ªæ–¹ä¾¿ã€‚ä¸Šé¢è¯´çš„ä¸¤ä¸ªå‡½æ•°é‡Œï¼Œ<code>copy_if</code> æ˜¯æŠŠæ»¡è¶³æ¡ä»¶çš„å…ƒç´ æ‹·è´åˆ°å¦å¤–ä¸€ä¸ªè¿­ä»£å™¨é‡Œï¼›<code>partition</code> åˆ™æ˜¯æ ¹æ®è¿‡æ»¤æ¡ä»¶æ¥å¯¹èŒƒå›´é‡Œçš„å…ƒç´ è¿›è¡Œåˆ†ç»„ï¼ŒæŠŠæ»¡è¶³æ¡ä»¶çš„æ”¾åœ¨è¿”å›å€¼è¿­ä»£å™¨çš„å‰é¢ã€‚å¦å¤–ï¼Œ<code>remove_if</code> ä¹Ÿæœ‰ç‚¹ç›¸è¿‘ï¼Œé€šå¸¸ç”¨äºåˆ é™¤æ»¡è¶³æ¡ä»¶çš„å…ƒç´ ã€‚å®ƒç¡®ä¿æŠŠä¸æ»¡è¶³æ¡ä»¶çš„å…ƒç´ æ”¾åœ¨è¿”å›å€¼è¿­ä»£å™¨çš„å‰é¢ï¼ˆä½†ä¸ä¿è¯æ»¡è¶³æ¡ä»¶çš„å…ƒç´ åœ¨å‡½æ•°è¿”å›åä¸€å®šå­˜åœ¨ï¼‰ï¼Œç„¶åä½ ä¸€èˆ¬éœ€è¦ä½¿ç”¨å®¹å™¨çš„ <code>erase</code> æˆå‘˜å‡½æ•°æ¥å°†å¾…åˆ é™¤çš„å…ƒç´ çœŸæ­£åˆ é™¤ã€‚</p><h3>å‘½ä»¤å¼ç¼–ç¨‹å’Œè¯´æ˜å¼ç¼–ç¨‹</h3><p>ä¼ ç»Ÿä¸Š C++ å±äºå‘½ä»¤å¼ç¼–ç¨‹ã€‚å‘½ä»¤å¼ç¼–ç¨‹é‡Œï¼Œä»£ç ä¼šæè¿°ç¨‹åºçš„å…·ä½“æ‰§è¡Œæ­¥éª¤ã€‚å¥½å¤„æ˜¯ä»£ç æ˜¾å¾—æ¯”è¾ƒç›´æˆªäº†å½“ï¼›ç¼ºç‚¹å°±æ˜¯å®¹æ˜“è®©äººåªè§æ ‘æœ¨ã€ä¸è§æ£®æ—ï¼Œåªèƒ½çœ‹åˆ°ä»£ç å•°å—¦åœ°æ€ä¹ˆåšï¼ˆhowï¼‰ï¼Œè€Œä¸æ˜¯åšä»€ä¹ˆï¼ˆwhatï¼‰ï¼Œæ›´ä¸ç”¨è¯´ä¸ºä»€ä¹ˆï¼ˆwhyï¼‰äº†ã€‚</p><p>è¯´æ˜å¼ç¼–ç¨‹åˆ™ç›¸åã€‚ä»¥æ•°æ®åº“æŸ¥è¯¢è¯­è¨€ SQL ä¸ºä¾‹ï¼ŒSQL æè¿°çš„æ˜¯ç±»ä¼¼äºä¸‹é¢çš„æ“ä½œï¼šä½ æƒ³ä»ä»€ä¹ˆåœ°æ–¹ï¼ˆfromï¼‰é€‰æ‹©ï¼ˆselectï¼‰æ»¡è¶³ä»€ä¹ˆæ¡ä»¶ï¼ˆwhereï¼‰çš„ä»€ä¹ˆæ•°æ®ï¼Œå¹¶å¯é€‰æŒ‡å®šæ’åºï¼ˆorder byï¼‰æˆ–åˆ†ç»„ï¼ˆgroup byï¼‰æ¡ä»¶ã€‚ä½ ä¸éœ€è¦å‘Šè¯‰æ•°æ®åº“å¼•æ“å…·ä½“è¯¥å¦‚ä½•å»æ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚äº‹å®ä¸Šï¼Œåœ¨é€‰æ‹©æŸ¥è¯¢ç­–ç•¥ä¸Šï¼Œå¤§éƒ¨åˆ†æ•°æ®åº“ç”¨æˆ·éƒ½ä¸åŠæ•°æ®åº“å¼•æ“â€œèªæ˜â€ï¼›æ­£å¦‚å¤§éƒ¨åˆ†å¼€å‘è€…åœ¨å†™å‡ºä¼˜åŒ–æ±‡ç¼–ä»£ç ä¸Šä¹Ÿä¸åŠç¼–è¯‘å™¨èªæ˜ä¸€æ ·ã€‚</p><p>è¿™å¹¶ä¸æ˜¯è¯´è¯´æ˜å¼ç¼–ç¨‹ä¸€å®šå°±ä¼˜äºå‘½ä»¤å¼ç¼–ç¨‹ã€‚äº‹å®ä¸Šï¼Œå¯¹äºå¾ˆå¤šç®—æ³•ï¼Œå‘½ä»¤å¼æ‰æ˜¯æœ€è‡ªç„¶çš„å®ç°ã€‚ä»¥å¿«é€Ÿæ’åºä¸ºä¾‹ï¼Œå¾ˆå¤šåœ°æ–¹åœ¨è®²åˆ°å‡½æ•°å¼ç¼–ç¨‹æ—¶ä¼šç»™å‡ºä¸‹é¢è¿™ä¸ª Haskellï¼ˆä¸€ç§çº¯å‡½æ•°å¼çš„ç¼–ç¨‹è¯­è¨€ï¼‰çš„ä¾‹å­æ¥è¯´æ˜å‡½æ•°å¼ç¼–ç¨‹çš„ç®€æ´æ€§ï¼š</p><pre><code class="language-haskell">quicksort []     = []
quicksort (p:xs) = (quicksort left)
         ++ [p] ++ (quicksort right)
  where
    left  = filter (&lt; p) xs
    right = filter (&gt;= p) xs
</code></pre><p>è¿™æ®µä»£ç ç®€æ´æ€§ç¡®å®æ²¡è¯è¯´ï¼Œä½†é—®é¢˜æ˜¯ï¼Œä¸Šé¢çš„ä»£ç çš„æ€§èƒ½å…¶å®éå¸¸ç³Ÿç³•ã€‚çœŸæ­£æ¥è¿‘ C++ æ€§èƒ½çš„å¿«é€Ÿæ’åºï¼Œåœ¨ Haskell é‡Œå†™å‡ºæ¥ä¸€ç‚¹ä¸ä¼˜é›…ï¼Œåè€Œæ›´ä¸‘é™‹ <span class="orange">[4]</span>ã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºï¼Œè¯´æ˜å¼ç¼–ç¨‹è·Ÿå‘½ä»¤å¼ç¼–ç¨‹å¯ä»¥ç»“åˆèµ·æ¥äº§ç”Ÿæ—¢ä¼˜é›…åˆé«˜æ•ˆçš„ä»£ç ã€‚å¯¹äºä»å‘½ä»¤å¼ç¼–ç¨‹æˆé•¿èµ·æ¥çš„å¤§éƒ¨åˆ†ç¨‹åºå‘˜ï¼Œæˆ‘çš„å»ºè®®æ˜¯ï¼š</p><ul>
<li>å†™è¡¨æ„çš„ä»£ç ï¼Œä¸è¦è¿‡äºä¸“æ³¨æ€§èƒ½è€Œè®©ä»£ç éš¾ä»¥ç»´æŠ¤â€”â€”è®°ä½é«˜å¾·çº³çš„åè¨€ï¼šâ€œè¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºã€‚â€</li>
<li>ä½¿ç”¨æœ‰æ„ä¹‰çš„å˜é‡ï¼Œä½†å°½é‡ä¸è¦å»ä¿®æ”¹å˜é‡å†…å®¹â€”â€”å˜é‡çš„ä¿®æ”¹éå¸¸å®¹æ˜“å¯¼è‡´ç¨‹åºå‘˜çš„æ€ç»´é”™è¯¯ã€‚</li>
<li>ç±»ä¼¼åœ°ï¼Œå°½é‡ä½¿ç”¨æ²¡æœ‰å‰¯ä½œç”¨çš„å‡½æ•°ï¼Œå¹¶è®©ä½ å†™çš„ä»£ç ä¹Ÿå°½é‡æ²¡æœ‰å‰¯ä½œç”¨ï¼Œç”¨è¿”å›å€¼æ¥ä»£è¡¨çŠ¶æ€çš„å˜åŒ–â€”â€”æ²¡æœ‰å‰¯ä½œç”¨çš„ä»£ç æ›´å®¹æ˜“æ¨ç†ï¼Œæ›´ä¸å®¹æ˜“å‡ºé”™ã€‚</li>
<li>ä»£ç çš„éšå¼ä¾èµ–è¶Šå°‘è¶Šå¥½ï¼Œå°¤å…¶æ˜¯ä¸è¦ä½¿ç”¨å…¨å±€å˜é‡â€”â€”éšå¼ä¾èµ–ä¼šè®©ä»£ç é‡Œçš„é”™è¯¯éš¾ä»¥æ’æŸ¥ï¼Œä¹Ÿä¼šè®©ä»£ç æ›´éš¾ä»¥æµ‹è¯•ã€‚</li>
<li>ä½¿ç”¨çŸ¥åçš„é«˜çº§ç¼–ç¨‹ç»“æ„ï¼Œå¦‚åŸºäºèŒƒå›´çš„ for å¾ªç¯ã€æ˜ å°„ã€å½’å¹¶ã€è¿‡æ»¤â€”â€”è¿™å¯ä»¥è®©ä½ çš„ä»£ç æ›´ç®€æ´ï¼Œæ›´æ˜“äºæ¨ç†ï¼Œå¹¶å‡å°‘ç±»ä¼¼ä¸‹æ ‡è¶Šç•Œè¿™ç§ä½çº§é”™è¯¯çš„å¯èƒ½æ€§ã€‚</li>
</ul><p>è¿™äº›è·Ÿå‡½æ•°å¼ç¼–ç¨‹æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿâ€”â€”è¿™äº›å·®ä¸å¤šéƒ½æ˜¯æ¥è‡ªå‡½æ•°å¼ç¼–ç¨‹çš„æœ€ä½³å®è·µã€‚å­¦ä¹ å‡½æ•°å¼ç¼–ç¨‹ï¼Œä¹Ÿæ˜¯ä¸ºäº†æ›´å¥½åœ°ä½“ä¼šå¦‚ä½•ä»è¿™äº›åœ°æ–¹å…¥æ‰‹ï¼Œå†™å‡ºæ˜“è¯»è€Œåˆé«˜æ€§èƒ½çš„ä»£ç ã€‚</p><h3>ä¸å¯å˜æ€§å’Œå¹¶å‘</h3><p>åœ¨å¤šæ ¸çš„æ—¶ä»£é‡Œï¼Œå‡½æ•°å¼ç¼–ç¨‹æ¯”ä»¥å‰æ›´å—é’çï¼Œä¸€ä¸ªé‡è¦çš„åŸå› æ˜¯å‡½æ•°å¼ç¼–ç¨‹å¯¹å¹¶è¡Œå¹¶å‘å¤©ç„¶å‹å¥½ã€‚å½±å“å¤šæ ¸æ€§èƒ½çš„ä¸€ä¸ªé‡è¦å› ç´ æ˜¯æ•°æ®çš„ç«äº‰æ¡ä»¶â€”â€”ç”±äºå…±äº«å†…å­˜æ•°æ®éœ€è¦åŠ é”å¸¦æ¥çš„å»¶è¿Ÿã€‚å‡½æ•°å¼ç¼–ç¨‹å¼ºè°ƒä¸å¯å˜æ€§ï¼ˆimmutabilityï¼‰ã€æ— å‰¯ä½œç”¨ï¼Œå¤©ç„¶å°±é€‚åˆå¹¶å‘ã€‚æ›´å¦™çš„æ˜¯ï¼Œå¦‚æœä½ ä½¿ç”¨é«˜å±‚æŠ½è±¡çš„è¯ï¼Œæœ‰æ—¶å¯ä»¥è½»è½»æ¾æ¾â€œå…è´¹â€å¾—åˆ°æ€§èƒ½æå‡ã€‚</p><p>æ‹¿æˆ‘ä»¬ä¸Šé¢çš„ä¾‹å­æ¥è¯´ï¼Œå¯¹ä»£ç åšä¸‹é¢çš„æ”¹é€ ï¼Œå¯ç”¨ C++17 çš„å¹¶è¡Œæ‰§è¡Œç­–ç•¥ <span class="orange">[5]</span>ï¼Œå°±èƒ½è‡ªåŠ¨è·å¾—åœ¨å¤šæ ¸ç¯å¢ƒä¸‹çš„æ€§èƒ½æå‡ï¼š</p><pre><code class="language-c++">int count_lines(const char** begin,
                const char** end)
{
  vector&lt;int&gt; count(end - begin);
  transform(execution::par,
            begin, end,
            count.begin(),
            count_file);
  return reduce(
    execution::par,
    count.begin(), count.end());
}
</code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªé«˜é˜¶å‡½æ•°çš„è°ƒç”¨ä¸­éƒ½åŠ å…¥äº† <code>execution::par</code>ï¼Œæ¥å¯åŠ¨è‡ªåŠ¨å¹¶è¡Œè®¡ç®—ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘æŠŠ <code>accumulate</code> æ¢æˆäº† <code>reduce</code> <span class="orange">[6]</span>ï¼ŒåŸå› æ˜¯å‰è€…å·²ç»å®šä¹‰æˆä»å·¦åˆ°å³çš„å½’å¹¶ï¼Œæ— æ³•å¹¶è¡Œã€‚<code>reduce</code> åˆ™ä¸åŒï¼Œåˆå§‹å€¼å¯ä»¥çœç•¥ï¼Œæ“ä½œä¸Šæ²¡æœ‰è§„å®šé¡ºåºï¼Œå¹¶åè¿‡æ¥è¦æ±‚å¯¹å…ƒç´ çš„å½’å¹¶æ“ä½œæ»¡è¶³äº¤æ¢å¾‹å’Œç»“åˆç‡ï¼ˆåŠ æ³•å½“ç„¶æ˜¯æ»¡è¶³çš„ï¼‰ï¼Œå³ï¼š</p><p>$$<br>
\begin{aligned}<br>
A\ \otimes\ B &amp;= B\ \otimes\ A\\\<br>
(A\ \otimes\ B)\ \otimes\ C &amp;= A\ \otimes\ (B\ \otimes\ C)<br>
\end{aligned}<br>
$$</p><p>å½“ç„¶ï¼Œåœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œä¸€èˆ¬æˆ‘ä»¬ä¸ä¼šæœ‰æµ·é‡æ–‡ä»¶ï¼Œå³ä½¿æœ‰æµ·é‡æ–‡ä»¶ï¼Œå¹¶è¡Œè¯»å–æ€§èƒ½ä¸€èˆ¬ä¹Ÿä¸ä¼šå¿«äºé¡ºåºè¯»å–ï¼Œæ‰€ä»¥æ„ä¹‰å¹¶ä¸æ˜¯å¾ˆå¤§ã€‚ä¸‹é¢è¿™ä¸ªç®€å•çš„ä¾‹å­å±•ç¤ºäº†å¹¶è¡Œ <code>reduce</code> çš„å¨åŠ›ï¼š</p><pre><code class="language-c++">#include &lt;chrono&gt;
#include &lt;execution&gt;
#include &lt;iostream&gt;
#include &lt;numeric&gt;
#include &lt;vector&gt;

using namespace std;

int main()
{
  vector&lt;double&gt; v(10000000, 0.0625);

  {
    auto t1 = chrono::
      high_resolution_clock::now();
    double result = accumulate(
      v.begin(), v.end(), 0.0);
    auto t2 = chrono::
      high_resolution_clock::now();
    chrono::duration&lt;double, milli&gt;
      ms = t2 - t1;
    cout &lt;&lt; "accumulate: result "
         &lt;&lt; result &lt;&lt; " took "
         &lt;&lt; ms.count() &lt;&lt; " ms\n";
  }

  {
    auto t1 = chrono::
      high_resolution_clock::now();
    double result =
      reduce(execution::par,
             v.begin(), v.end());
    auto t2 = chrono::
      high_resolution_clock::now();
    chrono::duration&lt;double, milli&gt;
      ms = t2 - t1;
    cout &lt;&lt; "reduce:     result "
         &lt;&lt; result &lt;&lt; " took "
         &lt;&lt; ms.count() &lt;&lt; " ms\n";
  }
}
</code></pre><p>åœ¨æˆ‘çš„ç”µè„‘ï¼ˆCore i7 å››æ ¸å…«çº¿ç¨‹ï¼‰ä¸Šçš„æŸæ¬¡æ‰§è¡Œç»“æœæ˜¯ï¼š</p><blockquote>
<p><code>accumulate: result 625000 took 26.122 ms</code><br>
<code>reduce: result 625000 took 4.485 ms</code></p>
</blockquote><p>æ‰§è¡Œç­–ç•¥è¿˜æ¯”è¾ƒæ–°ï¼Œè¿˜æ²¡æœ‰è¢«æ‰€æœ‰ç¼–è¯‘å™¨æ”¯æŒã€‚æˆ‘ç›®å‰æµ‹è¯•ä¸‹æ¥ï¼ŒMSVC æ²¡æœ‰é—®é¢˜ï¼ŒClang ä¸è¡Œï¼ŒGCC éœ€è¦å¤–éƒ¨åº“ TBBï¼ˆThreading Building Blocksï¼‰<span class="orange">[7]</span> çš„å¸®åŠ©ã€‚æˆ‘ä¸Šé¢æ˜¯ç”¨ GCC ç¼–è¯‘çš„ï¼Œå‘½ä»¤è¡Œæ˜¯ï¼š</p><blockquote>
<p><code>g++-9 -std=c++17 -O3 test.cpp -ltbb</code></p>
</blockquote><h2>Y ç»„åˆå­</h2><p>é™äºç¯‡å¹…ï¼Œè¿™ä¸€è®²æˆ‘ä»¬åªæ˜¯å¾ˆåˆæµ…åœ°æ¢è®¨äº†å‡½æ•°å¼ç¼–ç¨‹ã€‚å¯¹äº C++ çš„å‡½æ•°å¼ç¼–ç¨‹çš„æ·±å…¥æ¢è®¨æ˜¯æœ‰æ•´æœ¬ä¹¦çš„ï¼ˆè§å‚è€ƒèµ„æ–™ <span class="orange">[8]</span>ï¼‰ï¼Œè€Œä»Šå¤©è®²çš„å†…å®¹åœ¨ä¹¦çš„æœ€å‰é¢å‡ ç« å°±è¦†ç›–å®Œäº†ã€‚åœ¨åé¢ï¼Œæˆ‘ä»¬è¿˜ä¼šæ¢è®¨éƒ¨åˆ†çš„å‡½æ•°å¼ç¼–ç¨‹è¯é¢˜ï¼›ä»Šå¤©æˆ‘ä»¬åªå†è®¨è®ºä¸€ä¸ªæœ‰ç‚¹æœ‰è¶£ã€ä¹Ÿæœ‰ç‚¹çƒ§è„‘çš„è¯é¢˜ï¼ŒY ç»„åˆå­ <span class="orange">[9]</span>ã€‚ç¬¬ä¸€æ¬¡é˜…è¯»çš„æ—¶å€™ï¼Œå¦‚æœè§‰å¾—å›°éš¾ï¼Œå¯ä»¥è·³è¿‡è¿™ä¸€éƒ¨åˆ†ã€‚</p><p>ä¸è¿‡ï¼Œæˆ‘å¹¶ä¸æ‰“ç®—è®¨è®º Haskell Curry ä½¿ç”¨çš„ Y ç»„åˆå­å®šä¹‰â€”â€”è¿™ä¸ªæ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦å†™ä¸€ç¯‡å®Œæ•´çš„æ–‡ç« æ¥è®¨è®ºï¼ˆ<span class="orange">[10]</span>ï¼‰ï¼Œè€Œä¸”åœ¨ C++ ä¸­çš„å®ç”¨æ€§éå¸¸å¼±ã€‚æˆ‘ä»¬åªçœ‹å®ƒè§£å†³çš„é—®é¢˜ï¼šå¦‚ä½•åœ¨ lambda è¡¨è¾¾å¼ä¸­è¡¨ç°é€’å½’ã€‚</p><p>å›æƒ³ä¸€ä¸‹æˆ‘ä»¬ç”¨è¿‡çš„é˜¶ä¹˜çš„é€’å½’å®šä¹‰ï¼š</p><pre><code class="language-c++">int factorial(int n)
{
  if (n == 0) {
    return 1;
  } else {
    return n * factorial(n - 1);
  }
}
</code></pre><p>æ³¨æ„é‡Œé¢ç”¨åˆ°äº†é€’å½’ï¼Œæ‰€ä»¥ä½ è¦æŠŠå®ƒå†™æˆ lambda è¡¨è¾¾å¼æ˜¯æœ‰ç‚¹å›°éš¾çš„ï¼š</p><pre><code class="language-c++">auto factorial = [](int n) {
  if (n == 0) {
    return 1;
  } else {
    return n * ???(n - 1);
  }
}
</code></pre><p>ä¸‹é¢æˆ‘ä»¬è®¨è®ºä½¿ç”¨ Y ç»„åˆå­çš„è§£å†³æ–¹æ¡ˆã€‚</p><p>æˆ‘ä»¬é¦–å…ˆéœ€è¦ä¸€ä¸ªç‰¹æ®Šçš„é«˜é˜¶å‡½æ•°ï¼Œå®šä¹‰ä¸ºï¼š</p><p>$$<br>
y(f) = f(y(f))<br>
$$</p><p>æ˜¾ç„¶ï¼Œè¿™ä¸ªå®šä¹‰æœ‰ç‚¹å¥‡æ€ªã€‚äº‹å®ä¸Šï¼Œå®ƒæ˜¯ä¼šå¯¼è‡´æ— é™å±•å¼€çš„â€”â€”è€Œå®ƒçš„å¨åŠ›ä¹Ÿåœ¨äºæ— é™å±•å¼€ã€‚æˆ‘ä»¬ä¹Ÿå› æ­¤å¿…é¡»ä½¿ç”¨æƒ°æ€§æ±‚å€¼çš„æ–¹å¼æ‰èƒ½ä½¿ç”¨è¿™ä¸ªå®šä¹‰ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰é˜¶ä¹˜ä¸ºï¼š</p><p>$$<br>
\mathrm{fact}(n) = \mathrm{If\ IsZero}(n)\ \mathrm{then}\ 1\ \mathrm{else}\ n \times \mathrm{fact}(n âˆ’ 1)<br>
$$</p><p>å‡è®¾ $\mathrm{fact}$ å¯ä»¥è¡¨ç¤ºæˆ $y(F)$ï¼Œé‚£æˆ‘ä»¬å¯ä»¥åšä¸‹é¢çš„å˜å½¢ï¼š</p><p>$$<br>
\begin{aligned}<br>
y(F)(n) &amp;= \mathrm{If\ IsZero}(n)\ \mathrm{then}\ 1\ \mathrm{else}\ n \times y(F)(n âˆ’ 1)\\\<br>
F(y(F))(n) &amp;= \mathrm{If\ IsZero}(n)\ \mathrm{then}\ 1\ \mathrm{else}\ n \times y(F)(n âˆ’ 1)<br>
\end{aligned}<br>
$$</p><p>å†æŠŠ $y(F)$ æ›¿æ¢æˆ $f$ï¼Œæˆ‘ä»¬ä»ä¸Šé¢çš„ç¬¬äºŒä¸ªå¼å­å¾—åˆ°ï¼š</p><p>$$<br>
F(f)(n) = \mathrm{If\ IsZero}(n)\ \mathrm{then}\ 1\ \mathrm{else}\ n \times f(n âˆ’ 1)<br>
$$</p><p>æˆ‘ä»¬å¾—åˆ°äº† $F$ çš„å®šä¹‰ï¼Œä¹Ÿå°±è‡ªç„¶å¾—åˆ°äº† $\mathrm{fact}$ çš„å®šä¹‰ã€‚è€Œä¸”ï¼Œè¿™ä¸ªå®šä¹‰æ˜¯å¯ä»¥ç”¨ C++ è¡¨è¾¾å‡ºæ¥çš„ã€‚ä¸‹é¢æ˜¯å®Œæ•´çš„ä»£ç å®ç°ï¼š</p><pre><code class="language-c++">#include &lt;functional&gt;
#include &lt;iostream&gt;
#include &lt;type_traits&gt;
#include &lt;utility&gt;

using namespace std;

// Y combinator as presented by Yegor Derevenets in P0200R0
// &lt;url:http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2016/p0200r0.html&gt;
template &lt;class Fun&gt;
class y_combinator_result {
  Fun fun_;
public:
  template &lt;class T&gt;
  explicit y_combinator_result(
    T&amp;&amp; fun)
    : fun_(std::forward&lt;T&gt;(fun))
  {
  }

  template &lt;class... Args&gt;
  decltype(auto)
  operator()(Args&amp;&amp;... args)
  {
    // y(f) = f(y(f))
    return fun_(
      std::ref(*this),
      std::forward&lt;Args&gt;(args)...);
  }
};

template &lt;class Fun&gt;
decltype(auto)
y_combinator(Fun&amp;&amp; fun)
{
  return y_combinator_result&lt;
    std::decay_t&lt;Fun&gt;&gt;(
    std::forward&lt;Fun&gt;(fun));
}

int main()
{
  // ä¸Šé¢çš„é‚£ä¸ª F
  auto almost_fact =
    [](auto f, int n) -&gt; int {
    if (n == 0)
      return 1;
    else
      return n * f(n - 1);
  };
  // fact = y(F)
  auto fact =
    y_combinator(almost_fact);
  cout &lt;&lt; fact(10) &lt;&lt; endl;
}
</code></pre><p>è¿™ä¸€èŠ‚ä¸å½±å“åé¢çš„å†…å®¹ï¼Œçœ‹ä¸æ‡‚çš„å¯ä»¥æš‚æ—¶ç•¥è¿‡ã€‚ğŸ˜</p><h2>å†…å®¹å°ç»“</h2><p>æœ¬è®²æˆ‘ä»¬å¯¹å‡½æ•°å¼ç¼–ç¨‹è¿›è¡Œäº†ä¸€ä¸ªå…¥é—¨å¼çš„ä»‹ç»ï¼Œå¸Œæœ›ä½ å¯¹å‡½æ•°å¼ç¼–ç¨‹çš„ç‰¹ç‚¹ã€ä¼˜ç¼ºç‚¹æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„äº†è§£ã€‚ç„¶åï¼Œæˆ‘å¿«é€Ÿè®¨è®ºäº†ä¸€ä¸ªä¼šçƒ§è„‘çš„è¯é¢˜ï¼ŒY ç»„åˆå­ï¼Œè®©ä½ å¯¹å‡½æ•°å¼ç¼–ç¨‹çš„å¨åŠ›å’Œéš¾åº¦ä¹Ÿæœ‰æ‰€äº†è§£ã€‚</p><h2>è¯¾åæ€è€ƒ</h2><p>æƒ³ä¸€æƒ³ï¼Œä½ å¦‚ä½•å¯ä»¥å®ç°ä¸€ä¸ªæƒ°æ€§çš„è¿‡æ»¤å™¨ï¼Ÿä¸€ä¸ªæƒ°æ€§çš„è¿‡æ»¤å™¨åº”å½“è®©ä¸‹é¢çš„ä»£ç é€šè¿‡ç¼–è¯‘ï¼Œå¹¶ä¸”ä¸ä¼šå ç”¨è·Ÿæ•°æ®é›†å¤§å°ç›¸å…³çš„é¢å¤–ç©ºé—´ï¼š</p><pre><code class="language-c++">#include &lt;iostream&gt;
#include &lt;numeric&gt;
#include &lt;vector&gt;

using namespace std;

// filter_view çš„å®šä¹‰

int main()
{
  vector v{1, 2, 3, 4, 5};
  auto&amp;&amp; fv = filter_view(
    v.begin(), v.end(), [](int x) {
      return x % 2 == 0;
    });
  cout &lt;&lt; accumulate(fv.begin(),
                     fv.end(), 0)
       &lt;&lt; endl;
}
</code></pre><p>ç»“æœè¾“å‡ºåº”è¯¥æ˜¯ <code>6</code>ã€‚</p><p><strong>æç¤ºï¼š</strong>å‚è€ƒ <code>istream_line_reader</code> çš„å®ç°ã€‚</p><p>å‘Šè¯‰æˆ‘ä½ æ˜¯å¦æˆåŠŸäº†ï¼Œæˆ–è€…ä½ é‡åˆ°äº†ä»€ä¹ˆæ ·çš„ç‰¹åˆ«å›°éš¾ã€‚</p><h2><span class="reference">å‚è€ƒèµ„æ–™</span></h2><p><span class="reference">[1] cppreference.com, â€œstd::transformâ€. <a href="https://en.cppreference.com/w/cpp/algorithm/transform">https://en.cppreference.com/w/cpp/algorithm/transform</a> </span></p><p><span class="reference">[1a] cppreference.com, â€œstd::transformâ€. <a href="https://zh.cppreference.com/w/cpp/algorithm/transform">https://zh.cppreference.com/w/cpp/algorithm/transform</a> </span></p><p><span class="reference">[2] cppreference.com, â€œstd::accumulateâ€. <a href="https://en.cppreference.com/w/cpp/algorithm/accumulate">https://en.cppreference.com/w/cpp/algorithm/accumulate</a> </span></p><p><span class="reference">[2a] cppreference.com, â€œstd::accumulateâ€. <a href="https://zh.cppreference.com/w/cpp/algorithm/accumulate">https://zh.cppreference.com/w/cpp/algorithm/accumulate</a> </span></p><p><span class="reference">[3] cppreference.com, â€œStandard library header &lt;algorithm&gt;â€. <a href="https://en.cppreference.com/w/cpp/header/algorithm">https://en.cppreference.com/w/cpp/header/algorithm</a> </span></p><p><span class="reference">[3a] cppreference.com, â€œæ ‡å‡†åº“å¤´æ–‡ä»¶ &lt;algorithm&gt;â€. <a href="https://zh.cppreference.com/w/cpp/header/algorithm">https://zh.cppreference.com/w/cpp/header/algorithm</a> </span></p><p><span class="reference">[4] è¢è‹±æ°, â€œImmutability: The Dark Sideâ€. <a href="https://www.jianshu.com/p/13cd4c650125">https://www.jianshu.com/p/13cd4c650125</a> </span></p><p><span class="reference">[5] cppreference.com, â€œStandard library header &lt;execution&gt;â€. <a href="https://en.cppreference.com/w/cpp/header/execution">https://en.cppreference.com/w/cpp/header/execution</a> </span></p><p><span class="reference">[5a] cppreference.com, â€œæ ‡å‡†åº“å¤´æ–‡ä»¶ &lt;execution&gt;â€. <a href="https://zh.cppreference.com/w/cpp/header/execution">https://zh.cppreference.com/w/cpp/header/execution</a> </span></p><p><span class="reference">[6] cppreference.com, â€œstd::reduceâ€. <a href="https://en.cppreference.com/w/cpp/algorithm/reduce">https://en.cppreference.com/w/cpp/algorithm/reduce</a> </span></p><p><span class="reference">[6a] cppreference.com, â€œstd::reduceâ€. <a href="https://zh.cppreference.com/w/cpp/algorithm/reduce">https://zh.cppreference.com/w/cpp/algorithm/reduce</a> </span></p><p><span class="reference">[7] Intel, tbb. <a href="https://github.com/intel/tbb">https://github.com/intel/tbb</a> </span></p><p><span class="reference">[8] Ivan ÄŒukiÄ‡, <em>Functional Programming in C++</em>. Manning, 2019, <a href="https://www.manning.com/books/functional-programming-in-c-plus-plus">https://www.manning.com/books/functional-programming-in-c-plus-plus</a> </span></p><p><span class="reference">[9] Wikipedia, â€œFixed-point combinatorâ€. <a href="https://en.wikipedia.org/wiki/Fixed-point_combinator">https://en.wikipedia.org/wiki/Fixed-point_combinator</a> </span></p><p><span class="reference">[10] å´å’ç‚œ, â€œ<em>Y</em> Combinator and C++â€. <a href="https://yongweiwu.wordpress.com/2014/12/14/y-combinator-and-cplusplus/">https://yongweiwu.wordpress.com/2014/12/14/y-combinator-and-cplusplus/</a> </span></p><h2>ç²¾é€‰ç•™è¨€ï¼š</h2>
        <ul>
        
<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            å»–ç†ŠçŒ«  2020-01-03 08:33:22
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            Y-Combinatorä¸»è¦ç”¨åˆ°äº†ä¸€ä¸ªä¸åŠ¨ç‚¹ç†è®ºï¼Œåˆ˜æœªé¹è€å¸ˆçš„ã€Šåº·æ‰˜å°”ã€å“¥å¾·å°”ã€å›¾çµâ€”â€”æ°¸æ’çš„é‡‘è‰²å¯¹è§’çº¿ã€‹è¿™ç¯‡æ–‡ç« é‡Œé¢è¯´çš„ç›¸å¯¹è¯¦ç»†ä¸€äº›ã€‚ç©è¿‡ä¸€æ®µå‡½æ•°å¼...å°±åªæœ‰haskellé‚£æ®µä»£ç çœ‹æ‡‚äº†ğŸ˜‚ 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;        line-height:1.2">ä½œè€…å›å¤2020-01-03 09:13:40</div>
    <div style="color:#353535;font-weight:400;white-space:normal;        word-break:break-all;line-height:1.6">Y Combinator åªæ˜¯å¥½ç©å±•ç¤ºä¸€ä¸‹ï¼Œåˆºæ¿€ä¸€ä¸‹å¤§å®¶çš„å¥½å¥‡å¿ƒã€‚è¦è¿›ä¸€æ­¥äº†è§£ï¼Œæ˜¯éœ€è¦çœ‹å‚è€ƒèµ„æ–™ï¼Œæˆ–è€…å…¶ä»–ä¸­è‹±æ–‡èµ„æ–™çš„ã€‚ä½ è¯´çš„è¿™ç¯‡æˆ‘ä¹‹å‰æ²¡çœ‹è¿‡ï¼Œå†…å®¹ä¹Ÿä¸é”™ã€‚</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            hello world  2020-01-03 07:52:35
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            è¯·é—®è€å¸ˆï¼Œmapå’Œreduce.é‚£æ˜¯æœ€æ–°çš„è¯­å¥å—ï¼Ÿè¿˜æ˜¯æœ‰ç¬¬ä¸‰æ–¹åº“ï¼Ÿé‚£ä¸ªTBBï¼Ÿ 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;        line-height:1.2">ä½œè€…å›å¤2020-01-03 09:36:58</div>
    <div style="color:#353535;font-weight:400;white-space:normal;        word-break:break-all;line-height:1.6">map-reduce æ˜¯ä¸€ç§æ–¹æ³•ï¼Œå·²ç»æœ‰å¾ˆä¹…äº†ã€‚åœ¨ C++ é‡Œçš„ç›´æ¥å¯¹åº”æ˜¯ transform å’Œ accumulateã€‚TBB è§å‚è€ƒèµ„æ–™ [7]ã€‚</div>
</div>
            
    </div>
</li>
            </ul>
</div>
</body>
</html>