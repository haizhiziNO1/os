<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>02-è‡ªå·±åŠ¨æ‰‹ï¼Œå®ç°C--çš„æ™ºèƒ½æŒ‡é’ˆ</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <style>
        html {
            color: #333;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-rendering: optimizelegibility;
            font-family: Helvetica Neue, PingFang SC, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif
        }

        html.borderbox *,
        html.borderbox :after,
        html.borderbox :before {
            box-sizing: border-box
        }

        article,
        aside,
        blockquote,
        body,
        button,
        code,
        dd,
        details,
        dl,
        dt,
        fieldset,
        figcaption,
        figure,
        footer,
        form,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        header,
        hr,
        input,
        legend,
        li,
        menu,
        nav,
        ol,
        p,
        pre,
        section,
        td,
        textarea,
        th,
        ul {
            margin: 0;
            padding: 0
        }

        article,
        aside,
        details,
        figcaption,
        figure,
        footer,
        header,
        menu,
        nav,
        section {
            display: block
        }

        audio,
        canvas,
        video {
            display: inline-block
        }

        body,
        button,
        input,
        select,
        textarea {
            font: 300 1em/1.8 PingFang SC, Lantinghei SC, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, Helvetica, sans-serif
        }

        button::-moz-focus-inner,
        input::-moz-focus-inner {
            padding: 0;
            border: 0
        }

        table {
            border-collapse: collapse;
            border-spacing: 0
        }

        fieldset,
        img {
            border: 0
        }

        blockquote {
            position: relative;
            color: #999;
            font-weight: 400;
            border-left: 1px solid #1abc9c;
            padding-left: 1em;
            margin: 1em 3em 1em 2em
        }

        @media only screen and (max-width: 640px) {
            blockquote {
                margin: 1em 0
            }
        }

        abbr,
        acronym {
            border-bottom: 1px dotted;
            font-variant: normal
        }

        abbr {
            cursor: help
        }

        del {
            text-decoration: line-through
        }

        address,
        caption,
        cite,
        code,
        dfn,
        em,
        th,
        var {
            font-style: normal;
            font-weight: 400
        }

        ol,
        ul {
            list-style: none
        }

        caption,
        th {
            text-align: left
        }

        q:after,
        q:before {
            content: ""
        }

        sub,
        sup {
            font-size: 75%;
            line-height: 0;
            position: relative
        }

        :root sub,
        :root sup {
            vertical-align: baseline
        }

        sup {
            top: -.5em
        }

        sub {
            bottom: -.25em
        }

        a {
            color: #1abc9c
        }

        a:hover {
            text-decoration: underline
        }

        .typo a {
            border-bottom: 1px solid #1abc9c
        }

        .typo a:hover {
            border-bottom-color: #555;
            color: #555
        }

        .typo a:hover,
        a,
        ins {
            text-decoration: none
        }

        .typo-u,
        u {
            text-decoration: underline
        }

        mark {
            background: #fffdd1;
            border-bottom: 1px solid #ffedce;
            padding: 2px;
            margin: 0 5px
        }

        code,
        pre,
        pre tt {
            font-family: Courier, Courier New, monospace
        }

        pre {
            background: hsla(0, 0%, 97%, .7);
            border: 1px solid #ddd;
            padding: 1em 1.5em;
            display: block;
            -webkit-overflow-scrolling: touch
        }

        hr {
            border: none;
            border-bottom: 1px solid #cfcfcf;
            margin-bottom: .8em;
            height: 10px
        }

        .typo-small,
        figcaption,
        small {
            font-size: .9em;
            color: #888
        }

        b,
        strong {
            font-weight: 700;
            color: #000
        }

        [draggable] {
            cursor: move
        }

        .clearfix:after,
        .clearfix:before {
            content: "";
            display: table
        }

        .clearfix:after {
            clear: both
        }

        .clearfix {
            zoom: 1
        }

        .textwrap,
        .textwrap td,
        .textwrap th {
            word-wrap: break-word;
            word-break: break-all
        }

        .textwrap-table {
            table-layout: fixed
        }

        .serif {
            font-family: Palatino, Optima, Georgia, serif
        }

        .typo-dl,
        .typo-form,
        .typo-hr,
        .typo-ol,
        .typo-p,
        .typo-pre,
        .typo-table,
        .typo-ul,
        .typo dl,
        .typo form,
        .typo hr,
        .typo ol,
        .typo p,
        .typo pre,
        .typo table,
        .typo ul,
        blockquote {
            margin-bottom: 1rem
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: PingFang SC, Helvetica Neue, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif;
            color: #000;
            line-height: 1.35
        }

        .typo-h1,
        .typo-h2,
        .typo-h3,
        .typo-h4,
        .typo-h5,
        .typo-h6,
        .typo h1,
        .typo h2,
        .typo h3,
        .typo h4,
        .typo h5,
        .typo h6 {
            margin-top: 1.2em;
            margin-bottom: .6em;
            line-height: 1.35
        }

        .typo-h1,
        .typo h1 {
            font-size: 2em
        }

        .typo-h2,
        .typo h2 {
            font-size: 1.8em
        }

        .typo-h3,
        .typo h3 {
            font-size: 1.6em
        }

        .typo-h4,
        .typo h4 {
            font-size: 1.4em
        }

        .typo-h5,
        .typo-h6,
        .typo h5,
        .typo h6 {
            font-size: 1.2em
        }

        .typo-ul,
        .typo ul {
            margin-left: 1.3em;
            list-style: disc
        }

        .typo-ol,
        .typo ol {
            list-style: decimal;
            margin-left: 1.9em
        }

        .typo-ol ol,
        .typo-ol ul,
        .typo-ul ol,
        .typo-ul ul,
        .typo li ol,
        .typo li ul {
            margin-bottom: .8em;
            margin-left: 2em
        }

        .typo-ol ul,
        .typo-ul ul,
        .typo li ul {
            list-style: circle
        }

        .typo-table td,
        .typo-table th,
        .typo table caption,
        .typo table td,
        .typo table th {
            border: 1px solid #ddd;
            padding: .5em 1em;
            color: #666
        }

        .typo-table th,
        .typo table th {
            background: #fbfbfb
        }

        .typo-table thead th,
        .typo table thead th {
            background: hsla(0, 0%, 95%, .7)
        }

        .typo table caption {
            border-bottom: none
        }

        .typo-input,
        .typo-textarea {
            -webkit-appearance: none;
            border-radius: 0
        }

        .typo-em,
        .typo em,
        caption,
        legend {
            color: #000;
            font-weight: inherit
        }

        .typo-em {
            position: relative
        }

        .typo-em:after {
            position: absolute;
            top: .65em;
            left: 0;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            content: "\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB"
        }

        .typo img {
            max-width: 100%
        }

        .common-content {
            font-weight: 400;
            color: #353535;
            line-height: 1.75rem;
            white-space: normal;
            word-break: normal;
            font-size: 1rem
        }

        .common-content img {
            display: block;
            max-width: 100%;
            background-color: #eee
        }

        .common-content audio,
        .common-content video {
            width: 100%;
            background-color: #eee
        }

        .common-content center,
        .common-content font {
            margin-top: 1rem;
            display: inline-block
        }

        .common-content center {
            width: 100%
        }

        .common-content pre {
            margin-top: 1rem;
            padding-left: 0;
            padding-right: 0;
            position: relative;
            overflow: hidden
        }

        .common-content pre code {
            font-size: .8rem;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding-left: 1rem;
            padding-right: 1rem;
            overflow-x: auto
        }

        .common-content hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        .common-content b,
        .common-content h1,
        .common-content h2,
        .common-content h3,
        .common-content h4,
        .common-content h5,
        .common-content strong {
            font-weight: 700
        }

        .common-content h1,
        .common-content h2 {
            font-size: 1.125rem;
            margin-bottom: .45rem
        }

        .common-content h3,
        .common-content h4,
        .common-content h5 {
            font-size: 1rem;
            margin-bottom: .45rem
        }

        .common-content p {
            font-weight: 400;
            color: #353535;
            margin-top: .15rem
        }

        .common-content .orange {
            color: #ff5a05
        }

        .common-content .reference {
            font-size: 1rem;
            color: #888
        }

        .custom-rich-content h1 {
            margin-top: 0;
            font-weight: 400;
            font-size: 15.25px;
            border-bottom: 1px solid #eee;
            line-height: 2.8
        }

        .custom-rich-content li,
        .custom-rich-content p {
            font-size: 14px;
            color: #888;
            line-height: 1.6
        }

        table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        table.hljs-ln,
        table.hljs-ln tbody,
        table.hljs-ln td,
        table.hljs-ln tr {
            box-sizing: border-box
        }

        table.hljs-ln td {
            padding: 0;
            border: 0
        }

        table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            user-select: none
        }

        table.hljs-ln td.hljs-ln-code,
        table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            font-size: 12px;
            line-height: 20px;
            vertical-align: top
        }

        table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            color: #24292e;
            word-wrap: normal;
            white-space: pre
        }

        video::-webkit-media-controls {
            overflow: hidden !important
        }

        video::-webkit-media-controls-enclosure {
            width: calc(100% + 32px);
            margin-left: auto
        }

        ._29HP61GA_0 {
            max-width:800px;
            margin:0 auto;
            margin-bottom: 20px;
            font-weight: 400;
            color: #353535;
            line-height: 1.76;
            white-space: normal;
            word-break: normal;
            font-size: 17px;
            -webkit-transition: background-color .3s ease;
            transition: background-color .3s ease
        }

        ._29HP61GA_0 .MathJax_Display {
            overflow: auto
        }

        ._29HP61GA_0 .poster {
            position: fixed;
            left: -10000px;
            top: -10000px;
            overflow: hidden;
            padding: 1rem;
            background: #ececec
        }

        ._29HP61GA_0 .richcontent-pre-copy {
            font-size: 13px;
            color: #888;
            position: absolute;
            right: 1em;
            top: .5em;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 .richcontent-pre-copy .iconfont {
            font-size: 12px;
            margin-right: .2em
        }

        ._29HP61GA_0 a {
            color: #fa8919;
            border-bottom: 1px solid #fa8919
        }

        ._29HP61GA_0 img {
            display: block;
            max-width: 100%;
            position: relative;
            left: 50%;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            background-color: #eee;
            vertical-align: top;
            border-radius: 0
        }

        ._29HP61GA_0 audio,
        ._29HP61GA_0 video {
            width: 100%;
            background-color: #eee
        }

        ._29HP61GA_0 pre {
            margin-top: 16px;
            padding: 34px 0 0;
            margin-bottom: 30px;
            position: relative;
            border-radius: 6px;
            background: rgba(246, 247, 251, .749);
            border: 0
        }

        ._29HP61GA_0 pre code {
            font-size: 12px;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            margin-left: 16px;
            margin-right: 16px;
            overflow-x: scroll
        }

        ._29HP61GA_0 pre code:after {
            content: "";
            height: 30px;
            width: 100%;
            display: block
        }

        ._29HP61GA_0 hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        ._29HP61GA_0 h1,
        ._29HP61GA_0 h2,
        ._29HP61GA_0 h3,
        ._29HP61GA_0 h4,
        ._29HP61GA_0 h5 {
            margin-bottom: 20px;
            margin-top: 0;
            font-weight: 700
        }

        ._29HP61GA_0 b,
        ._29HP61GA_0 strong {
            font-weight: 700
        }

        ._29HP61GA_0 h1 {
            font-size: 21px
        }

        ._29HP61GA_0 h2 {
            font-size: 20px
        }

        ._29HP61GA_0 h3 {
            font-size: 19px
        }

        ._29HP61GA_0 h4 {
            font-size: 18px
        }

        ._29HP61GA_0 h5 {
            font-size: 17px
        }

        ._29HP61GA_0 center,
        ._29HP61GA_0 p {
            font-weight: 400;
            color: #353535;
            margin-top: 0;
            margin-bottom: 30px;
            word-break: break-word
        }

        ._29HP61GA_0 center {
            text-align: center
        }

        ._29HP61GA_0 blockquote {
            margin-top: 0;
            margin-bottom: 34px;
            border-left: 3px solid #e8e8e8;
            padding-left: 17px;
            color: #353535
        }

        ._29HP61GA_0 blockquote p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol,
        ._29HP61GA_0 ul {
            margin-bottom: 30px
        }

        ._29HP61GA_0 ol p,
        ._29HP61GA_0 ul p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol {
            list-style: decimal;
            margin-left: 20px
        }

        ._29HP61GA_0 ul li {
            padding-left: 17px;
            position: relative;
            margin-bottom: 10px
        }

        ._29HP61GA_0 ul li:after {
            content: "";
            height: 6px;
            width: 6px;
            border-radius: 50%;
            background: #353535;
            position: absolute;
            top: 10px;
            left: 0
        }

        ._29HP61GA_0 .orange {
            color: #fa8919
        }

        ._29HP61GA_0 .reference {
            color: #888
        }

        ._29HP61GA_0 .m-right {
            text-align: right
        }

        ._29HP61GA_0 .m-center {
            text-align: center;
            display: block
        }

        ._29HP61GA_0 .m-gray {
            color: #888
        }

        ._29HP61GA_0 .m-small {
            font-size: 15px
        }

        ._29HP61GA_0 table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        ._29HP61GA_0 table.hljs-ln,
        ._29HP61GA_0 table.hljs-ln tbody,
        ._29HP61GA_0 table.hljs-ln td,
        ._29HP61GA_0 table.hljs-ln tr {
            -webkit-box-sizing: border-box;
            box-sizing: border-box
        }

        ._29HP61GA_0 table.hljs-ln td {
            padding: 0;
            border: 0
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            font-size: 12px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code,
        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            line-height: 20px;
            vertical-align: top
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            font-size: 13px;
            color: #666;
            word-wrap: normal;
            white-space: pre
        }

    </style>
</head>
<body>
<div class="_29HP61GA_0">
<h1>02-è‡ªå·±åŠ¨æ‰‹ï¼Œå®ç°C--çš„æ™ºèƒ½æŒ‡é’ˆ</h1>
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å´å’ç‚œã€‚</p><p>ä¸Šä¸€è®²ï¼Œæˆ‘ä»¬æè¿°äº†ä¸€ä¸ªæŸç§ç¨‹åº¦ä¸Šå¯ä»¥å½“æˆæ™ºèƒ½æŒ‡é’ˆç”¨çš„ç±» <code>shape_wrapper</code>ã€‚ä½¿ç”¨é‚£ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œå¯ä»¥ç®€åŒ–èµ„æºçš„ç®¡ç†ï¼Œä»æ ¹æœ¬ä¸Šæ¶ˆé™¤èµ„æºï¼ˆåŒ…æ‹¬å†…å­˜ï¼‰æ³„æ¼çš„å¯èƒ½æ€§ã€‚è¿™ä¸€è®²æˆ‘ä»¬å°±æ¥è¿›ä¸€æ­¥è®²è§£ï¼Œå¦‚ä½•å°† <code>shape_wrapper</code> æ”¹é€ æˆä¸€ä¸ªå®Œæ•´çš„æ™ºèƒ½æŒ‡é’ˆã€‚ä½ ä¼šçœ‹åˆ°ï¼Œæ™ºèƒ½æŒ‡é’ˆæœ¬è´¨ä¸Šå¹¶ä¸ç¥ç§˜ï¼Œå…¶å®å°±æ˜¯ RAII èµ„æºç®¡ç†åŠŸèƒ½çš„è‡ªç„¶å±•ç°è€Œå·²ã€‚</p><p>åœ¨å­¦å®Œè¿™ä¸€è®²ä¹‹åï¼Œä½ åº”è¯¥ä¼šå¯¹ C++ çš„ <code>unique_ptr</code> å’Œ <code>shared_ptr</code> çš„åŠŸèƒ½éå¸¸ç†Ÿæ‚‰äº†ã€‚åŒæ—¶ï¼Œå¦‚æœä½ ä»Šåè¦åˆ›å»ºç±»ä¼¼çš„èµ„æºç®¡ç†ç±»ï¼Œä¹Ÿä¸ä¼šæ˜¯ä¸€ä»¶éš¾äº‹ã€‚</p><h2>å›é¡¾</h2><p>æˆ‘ä»¬ä¸Šä¸€è®²ç»™å‡ºäº†ä¸‹é¢è¿™ä¸ªç±»ï¼š</p><pre><code class="language-c++">class shape_wrapper {
public:
  explicit shape_wrapper(
    shape* ptr = nullptr)
    : ptr_(ptr) {}
  ~shape_wrapper()
  {
    delete ptr_;
  }
  shape* get() const { return ptr_; }

private:
  shape* ptr_;
};
</code></pre><p>è¿™ä¸ªç±»å¯ä»¥å®Œæˆæ™ºèƒ½æŒ‡é’ˆçš„æœ€åŸºæœ¬çš„åŠŸèƒ½ï¼šå¯¹è¶…å‡ºä½œç”¨åŸŸçš„å¯¹è±¡è¿›è¡Œé‡Šæ”¾ã€‚<strong>ä½†å®ƒç¼ºäº†ç‚¹ä¸œè¥¿ï¼š</strong></p><ol>
<li>è¿™ä¸ªç±»åªé€‚ç”¨äº <code>shape</code> ç±»</li>
<li>è¯¥ç±»å¯¹è±¡çš„è¡Œä¸ºä¸å¤ŸåƒæŒ‡é’ˆ</li>
<li>æ‹·è´è¯¥ç±»å¯¹è±¡ä¼šå¼•å‘ç¨‹åºè¡Œä¸ºå¼‚å¸¸</li>
</ol><!-- [[[read_end]]] --><p>ä¸‹é¢æˆ‘ä»¬æ¥é€ä¸€çœ‹ä¸€ä¸‹æ€ä¹ˆå¼¥è¡¥è¿™äº›é—®é¢˜ã€‚</p><h2>æ¨¡æ¿åŒ–å’Œæ˜“ç”¨æ€§</h2><p>è¦è®©è¿™ä¸ªç±»èƒ½å¤ŸåŒ…è£…ä»»æ„ç±»å‹çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒå˜æˆä¸€ä¸ªç±»æ¨¡æ¿ã€‚è¿™å®é™…ä¸Šç›¸å½“å®¹æ˜“ï¼š</p><pre><code class="language-c++">template &lt;typename T&gt;
class smart_ptr {
public:
  explicit smart_ptr(T* ptr = nullptr)
    : ptr_(ptr) {}
  ~smart_ptr()
  {
    delete ptr_;
  }
  T* get() const { return ptr_; }
private:
  T* ptr_;
};
</code></pre><p>å’Œ <code>shape_wrapper</code> æ¯”è¾ƒä¸€ä¸‹ï¼Œæˆ‘ä»¬å°±æ˜¯åœ¨å¼€å¤´å¢åŠ æ¨¡æ¿å£°æ˜ <code>template &lt;typename T&gt;</code>ï¼Œç„¶åæŠŠä»£ç ä¸­çš„ <code>shape</code> æ›¿æ¢æˆæ¨¡æ¿å‚æ•° <code>T</code> è€Œå·²ã€‚è¿™äº›ä¿®æ”¹éå¸¸ç®€å•è‡ªç„¶å§ï¼Ÿæ¨¡æ¿æœ¬è´¨ä¸Šå¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„æ¦‚å¿µã€‚è¿™ä¸ªæ¨¡æ¿ä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼ŒæŠŠåŸæ¥çš„ <code>shape_wrapper</code> æ”¹æˆ <code>smart_ptr&lt;shape&gt;</code> å°±è¡Œã€‚</p><p>ç›®å‰è¿™ä¸ª <code>smart_ptr</code> çš„è¡Œä¸ºè¿˜æ˜¯å’ŒæŒ‡é’ˆæœ‰ç‚¹å·®å¼‚çš„ï¼š</p><ul>
<li>å®ƒä¸èƒ½ç”¨ <code>*</code> è¿ç®—ç¬¦è§£å¼•ç”¨</li>
<li>å®ƒä¸èƒ½ç”¨ <code>-&gt;</code> è¿ç®—ç¬¦æŒ‡å‘å¯¹è±¡æˆå‘˜</li>
<li>å®ƒä¸èƒ½åƒæŒ‡é’ˆä¸€æ ·ç”¨åœ¨å¸ƒå°”è¡¨è¾¾å¼é‡Œ</li>
</ul><p>ä¸è¿‡ï¼Œè¿™äº›é—®é¢˜ä¹Ÿç›¸å½“å®¹æ˜“è§£å†³ï¼ŒåŠ å‡ ä¸ªæˆå‘˜å‡½æ•°å°±å¯ä»¥ï¼š</p><pre><code class="language-c++">template &lt;typename T&gt;
class smart_ptr {
public:
  â€¦
  T&amp; operator*() const { return *ptr_; }
  T* operator-&gt;() const { return ptr_; }
  operator bool() const { return ptr_; }
}
</code></pre><h2>æ‹·è´æ„é€ å’Œèµ‹å€¼</h2><p>æ‹·è´æ„é€ å’Œèµ‹å€¼ï¼Œæˆ‘ä»¬æš‚ä¸”ç®€ç§°ä¸ºæ‹·è´ï¼Œè¿™æ˜¯ä¸ªæ¯”è¾ƒå¤æ‚çš„é—®é¢˜äº†ã€‚å…³é”®è¿˜ä¸æ˜¯å®ç°é—®é¢˜ï¼Œè€Œæ˜¯æˆ‘ä»¬è¯¥å¦‚ä½•å®šä¹‰å…¶è¡Œä¸ºã€‚å‡è®¾æœ‰ä¸‹é¢çš„ä»£ç ï¼š</p><pre><code class="language-c++">smart_ptr&lt;shape&gt; ptr1{create_shape(shape_type::circle)};
smart_ptr&lt;shape&gt; ptr2{ptr1};
</code></pre><p>å¯¹äºç¬¬äºŒè¡Œï¼Œç©¶ç«Ÿåº”å½“è®©ç¼–è¯‘æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¿˜æ˜¯å¯ä»¥æœ‰ä¸€ä¸ªæ›´åˆç†çš„è¡Œä¸ºï¼Ÿæˆ‘ä»¬æ¥é€ä¸€æ£€æŸ¥ä¸€ä¸‹å„ç§å¯èƒ½æ€§ã€‚</p><p>æœ€ç®€å•çš„æƒ…å†µæ˜¾ç„¶æ˜¯ç¦æ­¢æ‹·è´ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç ï¼š</p><pre><code class="language-c++">template &lt;typename T&gt;
class smart_ptr {
  â€¦
  smart_ptr(const smart_ptr&amp;)
    = delete;
  smart_ptr&amp; operator=(const smart_ptr&amp;)
    = delete;
  â€¦
};
</code></pre><p>ç¦ç”¨è¿™ä¸¤ä¸ªå‡½æ•°éå¸¸ç®€å•ï¼Œä½†å´è§£å†³äº†ä¸€ç§å¯èƒ½å‡ºé”™çš„æƒ…å†µã€‚å¦åˆ™ï¼Œ<code>smart_ptr&lt;shape&gt; ptr2{ptr1};</code> åœ¨ç¼–è¯‘æ—¶ä¸ä¼šå‡ºé”™ï¼Œä½†åœ¨è¿è¡Œæ—¶å´ä¼šæœ‰æœªå®šä¹‰è¡Œä¸ºâ€”â€”ç”±äºä¼šå¯¹åŒä¸€å†…å­˜é‡Šæ”¾ä¸¤æ¬¡ï¼Œé€šå¸¸æƒ…å†µä¸‹ä¼šå¯¼è‡´ç¨‹åºå´©æºƒã€‚</p><p>æˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥è€ƒè™‘åœ¨æ‹·è´æ™ºèƒ½æŒ‡é’ˆæ—¶æŠŠå¯¹è±¡æ‹·è´ä¸€ä»½ï¼Ÿä¸è¡Œï¼Œé€šå¸¸äººä»¬ä¸ä¼šè¿™ä¹ˆç”¨ï¼Œå› ä¸ºä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆçš„ç›®çš„å°±æ˜¯è¦å‡å°‘å¯¹è±¡çš„æ‹·è´å•Šã€‚ä½•å†µï¼Œè™½ç„¶æˆ‘ä»¬çš„æŒ‡é’ˆç±»å‹æ˜¯ <code>shape</code>ï¼Œä½†å®é™…æŒ‡å‘çš„å´åº”è¯¥æ˜¯ <code>circle</code> æˆ– <code>triangle</code> ä¹‹ç±»çš„å¯¹è±¡ã€‚åœ¨ C++ é‡Œæ²¡æœ‰åƒ Java çš„ <code>clone</code> æ–¹æ³•è¿™æ ·çš„çº¦å®šï¼›ä¸€èˆ¬è€Œè¨€ï¼Œå¹¶æ²¡æœ‰é€šç”¨çš„æ–¹æ³•å¯ä»¥é€šè¿‡åŸºç±»çš„æŒ‡é’ˆæ¥æ„é€ å‡ºä¸€ä¸ªå­ç±»çš„å¯¹è±¡æ¥ã€‚</p><p>æˆ‘ä»¬è¦ä¹ˆè¯•è¯•åœ¨æ‹·è´æ—¶è½¬ç§»æŒ‡é’ˆçš„æ‰€æœ‰æƒï¼Ÿå¤§è‡´å®ç°å¦‚ä¸‹ï¼š</p><pre><code class="language-c++">template &lt;typename T&gt;
class smart_ptr {
  â€¦
  smart_ptr(smart_ptr&amp; other)
  {
    ptr_ = other.release();
  }
  smart_ptr&amp; operator=(smart_ptr&amp; rhs)
  {
    smart_ptr(rhs).swap(*this);
    return *this;
  }
  â€¦
  T* release()
  {
    T* ptr = ptr_;
    ptr_ = nullptr;
    return ptr;
  }
  void swap(smart_ptr&amp; rhs)
  {
    using std::swap;
    swap(ptr_, rhs.ptr_);
  }
  â€¦
};
</code></pre><p>åœ¨æ‹·è´æ„é€ å‡½æ•°ä¸­ï¼Œé€šè¿‡è°ƒç”¨ <code>other</code> çš„ <code>release</code> æ–¹æ³•æ¥é‡Šæ”¾å®ƒå¯¹æŒ‡é’ˆçš„æ‰€æœ‰æƒã€‚åœ¨èµ‹å€¼å‡½æ•°ä¸­ï¼Œåˆ™é€šè¿‡æ‹·è´æ„é€ äº§ç”Ÿä¸€ä¸ªä¸´æ—¶å¯¹è±¡å¹¶è°ƒç”¨ <code>swap</code> æ¥äº¤æ¢å¯¹æŒ‡é’ˆçš„æ‰€æœ‰æƒã€‚å®ç°ä¸Šæ˜¯ä¸å¤æ‚çš„ã€‚</p><p>å¦‚æœä½ å­¦åˆ°çš„èµ‹å€¼å‡½æ•°è¿˜æœ‰ä¸€ä¸ªç±»ä¼¼äº <code>if (this != &amp;rhs)</code> çš„åˆ¤æ–­çš„è¯ï¼Œé‚£ç§ç”¨æ³•æ›´å•°å—¦ï¼Œè€Œä¸”å¼‚å¸¸å®‰å…¨æ€§ä¸å¤Ÿå¥½â€”â€”å¦‚æœåœ¨èµ‹å€¼è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸çš„è¯ï¼Œthis å¯¹è±¡çš„å†…å®¹å¯èƒ½å·²ç»è¢«éƒ¨åˆ†ç ´åäº†ï¼Œå¯¹è±¡ä¸å†å¤„äºä¸€ä¸ªå®Œæ•´çš„çŠ¶æ€ã€‚</p><p><strong>ç›®å‰è¿™ç§æƒ¯ç”¨æ³•ï¼ˆè§å‚è€ƒèµ„æ–™ <span class="orange">[1]</span>ï¼‰åˆ™ä¿è¯äº†å¼ºå¼‚å¸¸å®‰å…¨æ€§ï¼š</strong>èµ‹å€¼åˆ†ä¸ºæ‹·è´æ„é€ å’Œäº¤æ¢ä¸¤æ­¥ï¼Œå¼‚å¸¸åªå¯èƒ½åœ¨ç¬¬ä¸€æ­¥å‘ç”Ÿï¼›è€Œç¬¬ä¸€æ­¥å¦‚æœå‘ç”Ÿå¼‚å¸¸çš„è¯ï¼Œthis å¯¹è±¡å®Œå…¨ä¸å—ä»»ä½•å½±å“ã€‚æ— è®ºæ‹·è´æ„é€ æˆåŠŸä¸å¦ï¼Œç»“æœåªæœ‰èµ‹å€¼æˆåŠŸå’Œèµ‹å€¼æ²¡æœ‰æ•ˆæœä¸¤ç§çŠ¶æ€ï¼Œè€Œä¸ä¼šå‘ç”Ÿå› ä¸ºèµ‹å€¼ç ´åäº†å½“å‰å¯¹è±¡è¿™ç§åœºæ™¯ã€‚</p><p>å¦‚æœä½ è§‰å¾—è¿™ä¸ªå®ç°è¿˜ä¸é”™çš„è¯ï¼Œé‚£æ­å–œä½ ï¼Œä½ è¾¾åˆ°äº† C++ å§”å‘˜ä¼šåœ¨ 1998 å¹´æ—¶çš„æ°´å¹³ï¼šä¸Šé¢ç»™å‡ºçš„è¯­ä¹‰æœ¬è´¨ä¸Šå°±æ˜¯ C++98 çš„ <code>auto_ptr</code> çš„å®šä¹‰ã€‚å¦‚æœä½ è§‰å¾—è¿™ä¸ªå®ç°å¾ˆåˆ«æ‰­çš„è¯ï¼Œä¹Ÿæ­å–œä½ ï¼Œå› ä¸º C++ å§”å‘˜ä¼šä¹Ÿæ˜¯è¿™ä¹ˆè§‰å¾—çš„ï¼š<code>auto_ptr</code> åœ¨ C++17 æ—¶å·²ç»è¢«æ­£å¼ä» C++ æ ‡å‡†é‡Œåˆ é™¤äº†ã€‚</p><p>ä¸Šé¢å®ç°çš„æœ€å¤§é—®é¢˜æ˜¯ï¼Œå®ƒçš„è¡Œä¸ºä¼šè®©ç¨‹åºå‘˜éå¸¸å®¹æ˜“çŠ¯é”™ã€‚ä¸€ä¸å°å¿ƒæŠŠå®ƒä¼ é€’ç»™å¦å¤–ä¸€ä¸ª <code>smart_ptr</code>ï¼Œä½ å°±ä¸å†æ‹¥æœ‰è¿™ä¸ªå¯¹è±¡äº†â€¦â€¦</p><h2>â€œç§»åŠ¨â€æŒ‡é’ˆï¼Ÿ</h2><p>åœ¨ä¸‹ä¸€è®²æˆ‘ä»¬å°†å®Œæ•´ä»‹ç»ä¸€ä¸‹ç§»åŠ¨è¯­ä¹‰ã€‚è¿™ä¸€è®²ï¼Œæˆ‘ä»¬å…ˆç®€å•çœ‹ä¸€ä¸‹ <code>smart_ptr</code> å¯ä»¥å¦‚ä½•ä½¿ç”¨â€œç§»åŠ¨â€æ¥æ”¹å–„å…¶è¡Œä¸ºã€‚</p><p>æˆ‘ä»¬éœ€è¦å¯¹ä»£ç åšä¸¤å¤„å°ä¿®æ”¹ï¼š</p><pre><code class="language-c++">template &lt;typename T&gt;
class smart_ptr {
  â€¦
  smart_ptr(smart_ptr&amp;&amp; other)
  {
    ptr_ = other.release();
  }
  smart_ptr&amp; operator=(smart_ptr rhs)
  {
    rhs.swap(*this);
    return *this;
  }
  â€¦
};
</code></pre><p>çœ‹åˆ°ä¿®æ”¹çš„åœ°æ–¹äº†å—ï¼Ÿæˆ‘æ”¹äº†ä¸¤ä¸ªåœ°æ–¹ï¼š</p><ul>
<li>æŠŠæ‹·è´æ„é€ å‡½æ•°ä¸­çš„å‚æ•°ç±»å‹ <code>smart_ptr&amp;</code> æ”¹æˆäº† <code>smart_ptr&amp;&amp;</code>ï¼›ç°åœ¨å®ƒæˆäº†ç§»åŠ¨æ„é€ å‡½æ•°ã€‚</li>
<li>æŠŠèµ‹å€¼å‡½æ•°ä¸­çš„å‚æ•°ç±»å‹ <code>smart_ptr&amp;</code> æ”¹æˆäº† <code>smart_ptr</code>ï¼Œåœ¨æ„é€ å‚æ•°æ—¶ç›´æ¥ç”Ÿæˆæ–°çš„æ™ºèƒ½æŒ‡é’ˆï¼Œä»è€Œä¸å†éœ€è¦åœ¨å‡½æ•°ä½“ä¸­æ„é€ ä¸´æ—¶å¯¹è±¡ã€‚ç°åœ¨èµ‹å€¼å‡½æ•°çš„è¡Œä¸ºæ˜¯ç§»åŠ¨è¿˜æ˜¯æ‹·è´ï¼Œå®Œå…¨ä¾èµ–äºæ„é€ å‚æ•°æ—¶èµ°çš„æ˜¯ç§»åŠ¨æ„é€ è¿˜æ˜¯æ‹·è´æ„é€ ã€‚</li>
</ul><p>æ ¹æ® C++ çš„è§„åˆ™ï¼Œå¦‚æœæˆ‘æä¾›äº†ç§»åŠ¨æ„é€ å‡½æ•°è€Œæ²¡æœ‰æ‰‹åŠ¨æä¾›æ‹·è´æ„é€ å‡½æ•°ï¼Œé‚£åè€…è‡ªåŠ¨è¢«ç¦ç”¨ï¼ˆè®°ä½ï¼ŒC++ é‡Œé‚£äº›å¤æ‚çš„è§„åˆ™ä¹Ÿæ˜¯ä¸ºæ–¹ä¾¿ç¼–ç¨‹è€Œè®¾ç«‹çš„ï¼‰ã€‚äºæ˜¯ï¼Œæˆ‘ä»¬è‡ªç„¶åœ°å¾—åˆ°äº†ä»¥ä¸‹ç»“æœï¼š</p><pre><code class="language-c++">smart_ptr&lt;shape&gt; ptr1{create_shape(shape_type::circle)};
smart_ptr&lt;shape&gt; ptr2{ptr1};             // ç¼–è¯‘å‡ºé”™
smart_ptr&lt;shape&gt; ptr3;
ptr3 = ptr1;                             // ç¼–è¯‘å‡ºé”™
ptr3 = std::move(ptr1);                  // OKï¼Œå¯ä»¥
smart_ptr&lt;shape&gt; ptr4{std::move(ptr3)};  // OKï¼Œå¯ä»¥
</code></pre><p>è¿™ä¸ªå°±è‡ªç„¶å¤šäº†ã€‚</p><p>è¿™ä¹Ÿæ˜¯ C++11 çš„ <code>unique_ptr</code> çš„åŸºæœ¬è¡Œä¸ºã€‚</p><h2>å­ç±»æŒ‡é’ˆå‘åŸºç±»æŒ‡é’ˆçš„è½¬æ¢</h2><p>å“¦ï¼Œæˆ‘æ’’äº†ä¸€ä¸ªå°è°ã€‚ä¸çŸ¥é“ä½ æ³¨æ„åˆ°æ²¡æœ‰ï¼Œä¸€ä¸ª <code>circle*</code> æ˜¯å¯ä»¥éšå¼è½¬æ¢æˆ <code>shape*</code> çš„ï¼Œä½†ä¸Šé¢çš„ <code>smart_ptr&lt;circle&gt;</code> å´æ— æ³•è‡ªåŠ¨è½¬æ¢æˆ <code>smart_ptr&lt;shape&gt;</code>ã€‚è¿™ä¸ªè¡Œä¸ºæ˜¾ç„¶è¿˜æ˜¯ä¸å¤Ÿâ€œè‡ªç„¶â€ã€‚</p><p>ä¸è¿‡ï¼Œåªéœ€è¦é¢å¤–åŠ ä¸€ç‚¹æ¨¡æ¿ä»£ç ï¼Œå°±èƒ½å®ç°è¿™ä¸€è¡Œä¸ºã€‚åœ¨æˆ‘ä»¬ç›®å‰ç»™å‡ºçš„å®ç°é‡Œï¼Œåªéœ€è¦ä¿®æ”¹æˆ‘ä»¬çš„ç§»åŠ¨æ„é€ å‡½æ•°ä¸€å¤„å³å¯â€”â€”è¿™ä¹Ÿç®—æ˜¯æˆ‘ä»¬è®©èµ‹å€¼å‡½æ•°ä½¿ç”¨æ‹·è´/ç§»åŠ¨æ„é€ å‡½æ•°çš„å¥½å¤„äº†ã€‚</p><pre><code class="language-c++">  template &lt;typename U&gt;
  smart_ptr(smart_ptr&lt;U&gt;&amp;&amp; other)
  {
    ptr_ = other.release();
  }
</code></pre><p>è¿™æ ·ï¼Œæˆ‘ä»¬è‡ªç„¶è€Œç„¶åˆ©ç”¨äº†æŒ‡é’ˆçš„è½¬æ¢ç‰¹æ€§ï¼šç°åœ¨ <code>smart_ptr&lt;circle&gt;</code> å¯ä»¥ç§»åŠ¨ç»™ <code>smart_ptr&lt;shape&gt;</code>ï¼Œä½†ä¸èƒ½ç§»åŠ¨ç»™ <code>smart_ptr&lt;triangle&gt;</code>ã€‚ä¸æ­£ç¡®çš„è½¬æ¢ä¼šåœ¨ä»£ç ç¼–è¯‘æ—¶ç›´æ¥æŠ¥é”™ã€‚</p><p>è‡³äºééšå¼çš„è½¬æ¢ï¼Œå› ä¸ºæœ¬æ¥å°±æ˜¯è¦å†™ç‰¹æ®Šçš„è½¬æ¢å‡½æ•°çš„ï¼Œæˆ‘ä»¬ç•™åˆ°è¿™ä¸€è®²çš„æœ€åå†è®¨è®ºã€‚</p><h2>å¼•ç”¨è®¡æ•°</h2><p><code>unique_ptr</code> ç®—æ˜¯ä¸€ç§è¾ƒä¸ºå®‰å…¨çš„æ™ºèƒ½æŒ‡é’ˆäº†ã€‚ä½†æ˜¯ï¼Œä¸€ä¸ªå¯¹è±¡åªèƒ½è¢«å•ä¸ª <code>unique_ptr</code> æ‰€æ‹¥æœ‰ï¼Œè¿™æ˜¾ç„¶ä¸èƒ½æ»¡è¶³æ‰€æœ‰ä½¿ç”¨åœºåˆçš„éœ€æ±‚ã€‚ä¸€ç§å¸¸è§çš„æƒ…å†µæ˜¯ï¼Œå¤šä¸ªæ™ºèƒ½æŒ‡é’ˆåŒæ—¶æ‹¥æœ‰ä¸€ä¸ªå¯¹è±¡ï¼›å½“å®ƒä»¬å…¨éƒ¨éƒ½å¤±æ•ˆæ—¶ï¼Œè¿™ä¸ªå¯¹è±¡ä¹ŸåŒæ—¶ä¼šè¢«åˆ é™¤ã€‚è¿™ä¹Ÿå°±æ˜¯ <code>shared_ptr</code> äº†ã€‚</p><p><code>unique_ptr</code> å’Œ <code>shared_ptr</code> çš„ä¸»è¦åŒºåˆ«å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static001.geekbang.org/resource/image/07/c8/072fc41e503d22c3ab2bf6a3801903c8.png" alt=""></p><p>å¤šä¸ªä¸åŒçš„ <code>shared_ptr</code> ä¸ä»…å¯ä»¥å…±äº«ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨å…±äº«åŒä¸€å¯¹è±¡æ—¶ä¹Ÿéœ€è¦åŒæ—¶å…±äº«åŒä¸€ä¸ªè®¡æ•°ã€‚å½“æœ€åä¸€ä¸ªæŒ‡å‘å¯¹è±¡ï¼ˆå’Œå…±äº«è®¡æ•°ï¼‰çš„ <code>shared_ptr</code> ææ„æ—¶ï¼Œå®ƒéœ€è¦åˆ é™¤å¯¹è±¡å’Œå…±äº«è®¡æ•°ã€‚æˆ‘ä»¬ä¸‹é¢å°±æ¥å®ç°ä¸€ä¸‹ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥å†™å‡ºå…±äº«è®¡æ•°çš„æ¥å£ï¼š</p><pre><code class="language-c++">class shared_count {
public:
  shared_count();
  void add_count();
  long reduce_count();
  long get_count() const;
};
</code></pre><p>è¿™ä¸ª <code>shared_count</code> ç±»é™¤æ„é€ å‡½æ•°ä¹‹å¤–æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼šä¸€ä¸ªå¢åŠ è®¡æ•°ï¼Œä¸€ä¸ªå‡å°‘è®¡æ•°ï¼Œä¸€ä¸ªè·å–è®¡æ•°ã€‚æ³¨æ„ä¸Šé¢çš„æ¥å£å¢åŠ è®¡æ•°ä¸éœ€è¦è¿”å›è®¡æ•°å€¼ï¼›ä½†å‡å°‘è®¡æ•°æ—¶éœ€è¦è¿”å›è®¡æ•°å€¼ï¼Œä»¥ä¾›è°ƒç”¨è€…åˆ¤æ–­æ˜¯å¦å®ƒå·²ç»æ˜¯æœ€åä¸€ä¸ªæŒ‡å‘å…±äº«è®¡æ•°çš„ <code>shared_ptr</code> äº†ã€‚ç”±äºçœŸæ­£å¤šçº¿ç¨‹å®‰å…¨çš„ç‰ˆæœ¬éœ€è¦ç”¨åˆ°æˆ‘ä»¬ç›®å‰è¿˜æ²¡å­¦åˆ°çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬ç›®å‰å…ˆå®ç°ä¸€ä¸ªç®€å•åŒ–çš„ç‰ˆæœ¬ï¼š</p><pre><code class="language-c++">class shared_count {
public:
  shared_count() : count_(1) {}
  void add_count()
  {
    ++count_;
  }
  long reduce_count()
  {
    return --count_;
  }
  long get_count() const
  {
    return count_;
  }

private:
  long count_;
};
</code></pre><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å®ç°æˆ‘ä»¬çš„å¼•ç”¨è®¡æ•°æ™ºèƒ½æŒ‡é’ˆäº†ã€‚é¦–å…ˆæ˜¯æ„é€ å‡½æ•°ã€ææ„å‡½æ•°å’Œç§æœ‰æˆå‘˜å˜é‡ï¼š</p><pre><code class="language-c++">template &lt;typename T&gt;
class smart_ptr {
public:
  explicit smart_ptr(T* ptr = nullptr)
    : ptr_(ptr)
  {
    if (ptr) {
      shared_count_ =
        new shared_count();
    }
  }
  ~smart_ptr()
  {
    if (ptr_ &amp;&amp;
      !shared_count_
         -&gt;reduce_count()) {
      delete ptr_;
      delete shared_count_;
    }
  }

private:
  T* ptr_;
  shared_count* shared_count_;
};
</code></pre><p>æ„é€ å‡½æ•°è·Ÿä¹‹å‰çš„ä¸»è¦ä¸åŒç‚¹æ˜¯ä¼šæ„é€ ä¸€ä¸ª <code>shared_count</code> å‡ºæ¥ã€‚ææ„å‡½æ•°åœ¨çœ‹åˆ° <code>ptr_</code> éç©ºæ—¶ï¼ˆæ­¤æ—¶æ ¹æ®ä»£ç é€»è¾‘ï¼Œ<code>shared_count</code> ä¹Ÿå¿…ç„¶éç©ºï¼‰ï¼Œéœ€è¦å¯¹å¼•ç”¨æ•°å‡ä¸€ï¼Œå¹¶åœ¨å¼•ç”¨æ•°é™åˆ°é›¶æ—¶å½»åº•åˆ é™¤å¯¹è±¡å’Œå…±äº«è®¡æ•°ã€‚åŸç†å°±æ˜¯è¿™æ ·ï¼Œä¸å¤æ‚ã€‚</p><p>å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜æœ‰äº›ç»†èŠ‚è¦å¤„ç†ã€‚ä¸ºäº†æ–¹ä¾¿å®ç°èµ‹å€¼ï¼ˆåŠå…¶ä»–ä¸€äº›æƒ¯ç”¨æ³•ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–°çš„ <code>swap</code> æˆå‘˜å‡½æ•°ï¼š</p><pre><code class="language-c++">  void swap(smart_ptr&amp; rhs)
  {
    using std::swap;
    swap(ptr_, rhs.ptr_);
    swap(shared_count_,
         rhs.shared_count_);
  }
</code></pre><p>èµ‹å€¼å‡½æ•°å¯ä»¥è·Ÿå‰é¢ä¸€æ ·ï¼Œä¿æŒä¸å˜ï¼Œä½†æ‹·è´æ„é€ å’Œç§»åŠ¨æ„é€ å‡½æ•°æ˜¯éœ€è¦æ›´æ–°ä¸€ä¸‹çš„ï¼š</p><pre><code class="language-c++">  template &lt;typename U&gt;
  smart_ptr(const smart_ptr&lt;U&gt;&amp; other)
  {
    ptr_ = other.ptr_;
    if (ptr_) {
      other.shared_count_
        -&gt;add_count();
      shared_count_ =
        other.shared_count_;
    }
  }
  template &lt;typename U&gt;
  smart_ptr(smart_ptr&lt;U&gt;&amp;&amp; other)
  {
    ptr_ = other.ptr_;
    if (ptr_) {
      shared_count_ =
        other.shared_count_;
      other.ptr_ = nullptr;
    }
  }
</code></pre><p>é™¤å¤åˆ¶æŒ‡é’ˆä¹‹å¤–ï¼Œå¯¹äºæ‹·è´æ„é€ çš„æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦åœ¨æŒ‡é’ˆéç©ºæ—¶æŠŠå¼•ç”¨æ•°åŠ ä¸€ï¼Œå¹¶å¤åˆ¶å…±äº«è®¡æ•°çš„æŒ‡é’ˆã€‚å¯¹äºç§»åŠ¨æ„é€ çš„æƒ…å†µï¼Œæˆ‘ä»¬ä¸éœ€è¦è°ƒæ•´å¼•ç”¨æ•°ï¼Œç›´æ¥æŠŠ <code>other.ptr_</code> ç½®ä¸ºç©ºï¼Œè®¤ä¸º <code>other</code> ä¸å†æŒ‡å‘è¯¥å…±äº«å¯¹è±¡å³å¯ã€‚</p><p>ä¸è¿‡ï¼Œä¸Šé¢çš„ä»£ç æœ‰ä¸ªé—®é¢˜ï¼šå®ƒä¸èƒ½æ­£ç¡®ç¼–è¯‘ã€‚ç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼Œåƒï¼š</p><blockquote>
<p>fatal error: â€˜ptr_â€™ is a private member of â€˜smart_ptr&lt;circle&gt;â€™</p>
</blockquote><p>é”™è¯¯åŸå› æ˜¯æ¨¡æ¿çš„å„ä¸ªå®ä¾‹é—´å¹¶ä¸å¤©ç„¶å°±æœ‰ friend å…³ç³»ï¼Œå› è€Œä¸èƒ½äº’è®¿ç§æœ‰æˆå‘˜ <code>ptr_</code> å’Œ <code>shared_count_</code>ã€‚æˆ‘ä»¬éœ€è¦åœ¨ <code>smart_ptr</code> çš„å®šä¹‰ä¸­æ˜¾å¼å£°æ˜ï¼š</p><pre><code class="language-c++">  template &lt;typename U&gt;
  friend class smart_ptr;
</code></pre><p>æ­¤å¤–ï¼Œæˆ‘ä»¬ä¹‹å‰çš„å®ç°ï¼ˆç±»ä¼¼äºå•ä¸€æ‰€æœ‰æƒçš„ <code>unique_ptr</code> ï¼‰ä¸­ç”¨ <code>release</code> æ¥æ‰‹å·¥é‡Šæ”¾æ‰€æœ‰æƒã€‚åœ¨ç›®å‰çš„å¼•ç”¨è®¡æ•°å®ç°ä¸­ï¼Œå®ƒå°±ä¸å¤ªåˆé€‚äº†ï¼Œåº”å½“åˆ é™¤ã€‚ä½†æˆ‘ä»¬è¦åŠ ä¸€ä¸ªå¯¹è°ƒè¯•éå¸¸æœ‰ç”¨çš„å‡½æ•°ï¼Œè¿”å›å¼•ç”¨è®¡æ•°å€¼ã€‚å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code class="language-c++">  long use_count() const
  {
    if (ptr_) {
      return shared_count_
        -&gt;get_count();
    } else {
      return 0;
    }
  }
</code></pre><p>è¿™å°±å·®ä¸å¤šæ˜¯ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„å¼•ç”¨è®¡æ•°æ™ºèƒ½æŒ‡é’ˆçš„å®ç°äº†ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç æ¥éªŒè¯ä¸€ä¸‹å®ƒçš„åŠŸèƒ½æ­£å¸¸ï¼š</p><pre><code class="language-c++">class shape {
public:
  virtual ~shape() {}
};

class circle : public shape {
public:
  ~circle() { puts("~circle()"); }
};

int main()
{
  smart_ptr&lt;circle&gt; ptr1(new circle());
  printf("use count of ptr1 is %ld\n",
         ptr1.use_count());
  smart_ptr&lt;shape&gt; ptr2;
  printf("use count of ptr2 was %ld\n",
         ptr2.use_count());
  ptr2 = ptr1;
  printf("use count of ptr2 is now %ld\n",
         ptr2.use_count());
  if (ptr1) {
    puts("ptr1 is not empty");
  }
}
</code></pre><p>è¿™æ®µä»£ç çš„è¿è¡Œç»“æœæ˜¯ï¼š</p><p><code>use count of ptr1 is 1</code><br>
<code>use count of ptr2 was 0</code><br>
<code>use count of ptr2 is now 2</code><br>
<code>ptr1 is not empty</code><br>
<code>~circle()</code></p><p>ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¼•ç”¨è®¡æ•°çš„å˜åŒ–ï¼Œä»¥åŠæœ€åå¯¹è±¡è¢«æˆåŠŸåˆ é™¤ã€‚</p><h2>æŒ‡é’ˆç±»å‹è½¬æ¢</h2><p>å¯¹åº”äº C++ é‡Œçš„ä¸åŒçš„ç±»å‹å¼ºåˆ¶è½¬æ¢ï¼š</p><ul>
<li>static_cast</li>
<li>reinterpret_cast</li>
<li>const_cast</li>
<li>dynamic_cast</li>
</ul><p>æ™ºèƒ½æŒ‡é’ˆéœ€è¦å®ç°ç±»ä¼¼çš„å‡½æ•°æ¨¡æ¿ã€‚å®ç°æœ¬èº«å¹¶ä¸å¤æ‚ï¼Œä½†ä¸ºäº†å®ç°è¿™äº›è½¬æ¢ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ æ„é€ å‡½æ•°ï¼Œå…è®¸åœ¨å¯¹æ™ºèƒ½æŒ‡é’ˆå†…éƒ¨çš„æŒ‡é’ˆå¯¹è±¡èµ‹å€¼æ—¶ï¼Œä½¿ç”¨ä¸€ä¸ªç°æœ‰çš„æ™ºèƒ½æŒ‡é’ˆçš„å…±äº«è®¡æ•°ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class="language-c++">  template &lt;typename U&gt;
  smart_ptr(const smart_ptr&lt;U&gt;&amp; other,
            T* ptr)
  {
    ptr_ = ptr;
    if (ptr_) {
      other.shared_count_
        -&gt;add_count();
      shared_count_ =
        other.shared_count_;
    }
  }
</code></pre><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å®ç°è½¬æ¢æ‰€éœ€çš„å‡½æ•°æ¨¡æ¿äº†ã€‚ä¸‹é¢å®ç°ä¸€ä¸ª <code>dynamic_pointer_cast</code> æ¥ç¤ºä¾‹ä¸€ä¸‹ï¼š</p><pre><code class="language-c++">template &lt;typename T, typename U&gt;
smart_ptr&lt;T&gt; dynamic_pointer_cast(
  const smart_ptr&lt;U&gt;&amp; other)
{
  T* ptr =
    dynamic_cast&lt;T*&gt;(other.get());
  return smart_ptr&lt;T&gt;(other, ptr);
}
</code></pre><p>åœ¨å‰é¢çš„éªŒè¯ä»£ç åé¢æˆ‘ä»¬å¯ä»¥åŠ ä¸Šï¼š</p><pre><code class="language-c++">  smart_ptr&lt;circle&gt; ptr3 =
    dynamic_pointer_cast&lt;circle&gt;(ptr2);
  printf("use count of ptr3 is %ld\n",
         ptr3.use_count());
</code></pre><p>ç¼–è¯‘ä¼šæ­£å¸¸é€šè¿‡ï¼ŒåŒæ—¶èƒ½åœ¨è¾“å‡ºé‡Œçœ‹åˆ°ä¸‹é¢çš„ç»“æœï¼š</p><blockquote>
<p>use count of ptr3 is 3</p>
</blockquote><p>æœ€åï¼Œå¯¹è±¡ä»ç„¶èƒ½å¤Ÿè¢«æ­£ç¡®åˆ é™¤ã€‚è¿™è¯´æ˜æˆ‘ä»¬çš„å®ç°æ˜¯æ­£ç¡®çš„ã€‚</p><h2>ä»£ç åˆ—è¡¨</h2><p>ä¸ºäº†æ–¹ä¾¿ä½ å‚è€ƒï¼Œä¸‹é¢æˆ‘ç»™å‡ºäº†ä¸€ä¸ªå®Œæ•´çš„ <code>smart_ptr</code> ä»£ç åˆ—è¡¨ï¼š</p><pre><code class="language-c++">#include &lt;utility&gt;  // std::swap

class shared_count {
public:
  shared_count() noexcept
    : count_(1) {}
  void add_count() noexcept
  {
    ++count_;
  }
  long reduce_count() noexcept
  {
    return --count_;
  }
  long get_count() const noexcept
  {
    return count_;
  }

private:
  long count_;
};

template &lt;typename T&gt;
class smart_ptr {
public:
  template &lt;typename U&gt;
  friend class smart_ptr;

  explicit smart_ptr(T* ptr = nullptr)
    : ptr_(ptr)
  {
    if (ptr) {
      shared_count_ =
        new shared_count();
    }
  }
  ~smart_ptr()
  {
    printf("~smart_ptr(): %p\n", this);
    if (ptr_ &amp;&amp;
      !shared_count_
         -&gt;reduce_count()) {
      delete ptr_;
      delete shared_count_;
    }
  }

  template &lt;typename U&gt;
  smart_ptr(const smart_ptr&lt;U&gt;&amp; other) noexcept
  {
    ptr_ = other.ptr_;
    if (ptr_) {
      other.shared_count_-&gt;add_count();
      shared_count_ = other.shared_count_;
    }
  }
  template &lt;typename U&gt;
  smart_ptr(smart_ptr&lt;U&gt;&amp;&amp; other) noexcept
  {
    ptr_ = other.ptr_;
    if (ptr_) {
      shared_count_ =
        other.shared_count_;
      other.ptr_ = nullptr;
    }
  }
  template &lt;typename U&gt;
  smart_ptr(const smart_ptr&lt;U&gt;&amp; other,
            T* ptr) noexcept
  {
    ptr_ = ptr;
    if (ptr_) {
      other.shared_count_
        -&gt;add_count();
      shared_count_ =
        other.shared_count_;
    }
  }
  smart_ptr&amp;
  operator=(smart_ptr rhs) noexcept
  {
    rhs.swap(*this);
    return *this;
  }

  T* get() const noexcept
  {
    return ptr_;
  }
  long use_count() const noexcept
  {
    if (ptr_) {
      return shared_count_
        -&gt;get_count();
    } else {
      return 0;
    }
  }
  void swap(smart_ptr&amp; rhs) noexcept
  {
    using std::swap;
    swap(ptr_, rhs.ptr_);
    swap(shared_count_,
         rhs.shared_count_);
  }

  T&amp; operator*() const noexcept
  {
    return *ptr_;
  }
  T* operator-&gt;() const noexcept
  {
    return ptr_;
  }
  operator bool() const noexcept
  {
    return ptr_;
  }

private:
  T* ptr_;
  shared_count* shared_count_;
};

template &lt;typename T&gt;
void swap(smart_ptr&lt;T&gt;&amp; lhs,
          smart_ptr&lt;T&gt;&amp; rhs) noexcept
{
  lhs.swap(rhs);
}

template &lt;typename T, typename U&gt;
smart_ptr&lt;T&gt; static_pointer_cast(
  const smart_ptr&lt;U&gt;&amp; other) noexcept
{
  T* ptr = static_cast&lt;T*&gt;(other.get());
  return smart_ptr&lt;T&gt;(other, ptr);
}

template &lt;typename T, typename U&gt;
smart_ptr&lt;T&gt; reinterpret_pointer_cast(
  const smart_ptr&lt;U&gt;&amp; other) noexcept
{
  T* ptr = reinterpret_cast&lt;T*&gt;(other.get());
  return smart_ptr&lt;T&gt;(other, ptr);
}

template &lt;typename T, typename U&gt;
smart_ptr&lt;T&gt; const_pointer_cast(
  const smart_ptr&lt;U&gt;&amp; other) noexcept
{
  T* ptr = const_cast&lt;T*&gt;(other.get());
  return smart_ptr&lt;T&gt;(other, ptr);
}

template &lt;typename T, typename U&gt;
smart_ptr&lt;T&gt; dynamic_pointer_cast(
  const smart_ptr&lt;U&gt;&amp; other) noexcept
{
  T* ptr = dynamic_cast&lt;T*&gt;(other.get());
  return smart_ptr&lt;T&gt;(other, ptr);
}
</code></pre><p>å¦‚æœä½ è¶³å¤Ÿç»†å¿ƒçš„è¯ï¼Œä½ ä¼šå‘ç°æˆ‘åœ¨ä»£ç é‡ŒåŠ äº†ä¸å°‘ <code>noexcept</code>ã€‚è¿™å¯¹è¿™ä¸ªæ™ºèƒ½æŒ‡é’ˆåœ¨å®ƒçš„ç›®æ ‡åœºæ™¯èƒ½æ­£ç¡®ä½¿ç”¨æ˜¯ååˆ†å¿…è¦çš„ã€‚æˆ‘ä»¬ä¼šåœ¨ä¸‹é¢çš„å‡ è®²é‡Œå›åˆ°è¿™ä¸ªè¯é¢˜ã€‚</p><h2>å†…å®¹å°ç»“</h2><p>è¿™ä¸€è®²æˆ‘ä»¬ä» <code>shape_wrapper</code> å‡ºå‘ï¼Œå®ç°äº†ä¸€ä¸ªåŸºæœ¬å®Œæ•´çš„å¸¦å¼•ç”¨è®¡æ•°çš„æ™ºèƒ½æŒ‡é’ˆã€‚è¿™ä¸ªæ™ºèƒ½æŒ‡é’ˆè·Ÿæ ‡å‡†çš„ <code>shared_ptr</code> æ¯”ï¼Œè¿˜ç¼ºäº†ä¸€äº›ä¸œè¥¿ï¼ˆè§å‚è€ƒèµ„æ–™ <span class="orange">[2]</span>ï¼‰ï¼Œä½†æ—¥å¸¸ç”¨åˆ°çš„æ™ºèƒ½æŒ‡é’ˆåŠŸèƒ½å·²ç»åŒ…å«åœ¨å†…ã€‚ç°åœ¨ï¼Œä½ åº”å½“å·²ç»å¯¹æ™ºèƒ½æŒ‡é’ˆæœ‰ä¸€ä¸ªè¾ƒä¸ºæ·±å…¥çš„ç†è§£äº†ã€‚</p><h2>è¯¾åæ€è€ƒ</h2><p>è¿™é‡Œç•™å‡ ä¸ªé—®é¢˜ï¼Œä½ å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼š</p><ol>
<li>ä¸æŸ¥é˜… <code>shared_ptr</code> çš„æ–‡æ¡£ï¼Œä½ è§‰å¾—ç›®å‰ <code>smart_ptr</code> åº”å½“æ·»åŠ ä»€ä¹ˆåŠŸèƒ½å—ï¼Ÿ</li>
<li>ä½ æƒ³åˆ°çš„åŠŸèƒ½åœ¨æ ‡å‡†çš„ <code>shared_ptr</code> é‡Œå—ï¼Ÿ</li>
<li>ä½ è§‰å¾—æ™ºèƒ½æŒ‡é’ˆåº”è¯¥æ»¡è¶³ä»€ä¹ˆæ ·çš„çº¿ç¨‹å®‰å…¨æ€§ï¼Ÿ</li>
</ol><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘äº¤æµä½ çš„çœ‹æ³•ã€‚</p><h2><span class="reference">å‚è€ƒèµ„æ–™</span></h2><p><span class="reference">[1] Stack Overflow, GManNickGâ€™s answer to â€œWhat is the copy-and-swap idiom?â€. <a href="https://stackoverflow.com/a/3279550/816999">https://stackoverflow.com/a/3279550/816999</a></span></p><p><span class="reference">[2] cppreference.com, â€œstd::shared_ptrâ€. <a href="https://en.cppreference.com/w/cpp/memory/shared_ptr">https://en.cppreference.com/w/cpp/memory/shared_ptr</a></span></p><h2>ç²¾é€‰ç•™è¨€ï¼š</h2>
        <ul>
        
<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            å°ç¾  2019-11-26 10:08:47
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            è®¡æ•°å™¨çº¿ç¨‹å®‰å…¨æ˜¯ä¸æ˜¯æ›´å¥½ç‚¹ [1èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            Lilin  2019-11-26 09:03:12
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            æ‰ç¬¬äºŒèŠ‚ï¼Œå°±æœ‰ç‚¹åƒåŠ›äº†ã€‚è¿™ç¯‡ä¸“æ çœŸæ˜¯æ»¡æ»¡çš„å¹²è´§ [1èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            æµæµªåœ°çƒ  2019-11-26 10:19:00
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            è€å¸ˆæ‚¨å¥½ï¼Œé—®ä¸€ä¸ªæ¯”è¾ƒåŸºç¡€çš„é—®é¢˜ï¼Œæˆ‘ç†è§£è¿™ä¸ªè¯­å¥<br>smart_ptr&lt;shape&gt;  ptr1{create_shape(shape_type::circle)};  æ˜¯è°ƒç”¨ptr1çš„æ‹·è´æ„é€ å‡½æ•°ã€‚<br>ä¸ºä»€ä¹ˆ{create_shape(shape_type::circle)}æ˜¯ä½¿ç”¨å¤§æ‹¬å·ï¼Œä¸åº”è¯¥æ˜¯å°æ‹¬å·å—ï¼Ÿ<br>è°¢è°¢<br> 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            Txz  2019-11-25 23:14:22
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            ä¸€éä¸‹æ¥ï¼Œè¿˜æ˜¯è§‰å¾—ç†è§£çš„ä¸å¤Ÿï¼Œåªèƒ½åå¤é˜…è¯»ã€‚ 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;        line-height:1.2">ä½œè€…å›å¤2019-11-26 09:43:22</div>
    <div style="color:#353535;font-weight:400;white-space:normal;        word-break:break-all;line-height:1.6">æ²¡å…³ç³»çš„ã€‚å­¦ä¹ å°±æ˜¯è¦å¤šè¯»å¤šå†™å¤šç»ƒã€‚</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            å¤©å¤©  2019-11-25 22:14:45
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            é¢è¯•é«˜é¢‘é¢˜ç›® 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;        line-height:1.2">ä½œè€…å›å¤2019-11-25 22:49:01</div>
    <div style="color:#353535;font-weight:400;white-space:normal;        word-break:break-all;line-height:1.6">ğŸ˜„</div>
</div>
            
    </div>
</li>
            </ul>
</div>
</body>
</html>