<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>30-Coroutinesï¼šåä½œå¼çš„äº¤å‰è°ƒåº¦æ‰§è¡Œ</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <style>
        html {
            color: #333;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-rendering: optimizelegibility;
            font-family: Helvetica Neue, PingFang SC, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif
        }

        html.borderbox *,
        html.borderbox :after,
        html.borderbox :before {
            box-sizing: border-box
        }

        article,
        aside,
        blockquote,
        body,
        button,
        code,
        dd,
        details,
        dl,
        dt,
        fieldset,
        figcaption,
        figure,
        footer,
        form,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        header,
        hr,
        input,
        legend,
        li,
        menu,
        nav,
        ol,
        p,
        pre,
        section,
        td,
        textarea,
        th,
        ul {
            margin: 0;
            padding: 0
        }

        article,
        aside,
        details,
        figcaption,
        figure,
        footer,
        header,
        menu,
        nav,
        section {
            display: block
        }

        audio,
        canvas,
        video {
            display: inline-block
        }

        body,
        button,
        input,
        select,
        textarea {
            font: 300 1em/1.8 PingFang SC, Lantinghei SC, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, Helvetica, sans-serif
        }

        button::-moz-focus-inner,
        input::-moz-focus-inner {
            padding: 0;
            border: 0
        }

        table {
            border-collapse: collapse;
            border-spacing: 0
        }

        fieldset,
        img {
            border: 0
        }

        blockquote {
            position: relative;
            color: #999;
            font-weight: 400;
            border-left: 1px solid #1abc9c;
            padding-left: 1em;
            margin: 1em 3em 1em 2em
        }

        @media only screen and (max-width: 640px) {
            blockquote {
                margin: 1em 0
            }
        }

        abbr,
        acronym {
            border-bottom: 1px dotted;
            font-variant: normal
        }

        abbr {
            cursor: help
        }

        del {
            text-decoration: line-through
        }

        address,
        caption,
        cite,
        code,
        dfn,
        em,
        th,
        var {
            font-style: normal;
            font-weight: 400
        }

        ol,
        ul {
            list-style: none
        }

        caption,
        th {
            text-align: left
        }

        q:after,
        q:before {
            content: ""
        }

        sub,
        sup {
            font-size: 75%;
            line-height: 0;
            position: relative
        }

        :root sub,
        :root sup {
            vertical-align: baseline
        }

        sup {
            top: -.5em
        }

        sub {
            bottom: -.25em
        }

        a {
            color: #1abc9c
        }

        a:hover {
            text-decoration: underline
        }

        .typo a {
            border-bottom: 1px solid #1abc9c
        }

        .typo a:hover {
            border-bottom-color: #555;
            color: #555
        }

        .typo a:hover,
        a,
        ins {
            text-decoration: none
        }

        .typo-u,
        u {
            text-decoration: underline
        }

        mark {
            background: #fffdd1;
            border-bottom: 1px solid #ffedce;
            padding: 2px;
            margin: 0 5px
        }

        code,
        pre,
        pre tt {
            font-family: Courier, Courier New, monospace
        }

        pre {
            background: hsla(0, 0%, 97%, .7);
            border: 1px solid #ddd;
            padding: 1em 1.5em;
            display: block;
            -webkit-overflow-scrolling: touch
        }

        hr {
            border: none;
            border-bottom: 1px solid #cfcfcf;
            margin-bottom: .8em;
            height: 10px
        }

        .typo-small,
        figcaption,
        small {
            font-size: .9em;
            color: #888
        }

        b,
        strong {
            font-weight: 700;
            color: #000
        }

        [draggable] {
            cursor: move
        }

        .clearfix:after,
        .clearfix:before {
            content: "";
            display: table
        }

        .clearfix:after {
            clear: both
        }

        .clearfix {
            zoom: 1
        }

        .textwrap,
        .textwrap td,
        .textwrap th {
            word-wrap: break-word;
            word-break: break-all
        }

        .textwrap-table {
            table-layout: fixed
        }

        .serif {
            font-family: Palatino, Optima, Georgia, serif
        }

        .typo-dl,
        .typo-form,
        .typo-hr,
        .typo-ol,
        .typo-p,
        .typo-pre,
        .typo-table,
        .typo-ul,
        .typo dl,
        .typo form,
        .typo hr,
        .typo ol,
        .typo p,
        .typo pre,
        .typo table,
        .typo ul,
        blockquote {
            margin-bottom: 1rem
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: PingFang SC, Helvetica Neue, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif;
            color: #000;
            line-height: 1.35
        }

        .typo-h1,
        .typo-h2,
        .typo-h3,
        .typo-h4,
        .typo-h5,
        .typo-h6,
        .typo h1,
        .typo h2,
        .typo h3,
        .typo h4,
        .typo h5,
        .typo h6 {
            margin-top: 1.2em;
            margin-bottom: .6em;
            line-height: 1.35
        }

        .typo-h1,
        .typo h1 {
            font-size: 2em
        }

        .typo-h2,
        .typo h2 {
            font-size: 1.8em
        }

        .typo-h3,
        .typo h3 {
            font-size: 1.6em
        }

        .typo-h4,
        .typo h4 {
            font-size: 1.4em
        }

        .typo-h5,
        .typo-h6,
        .typo h5,
        .typo h6 {
            font-size: 1.2em
        }

        .typo-ul,
        .typo ul {
            margin-left: 1.3em;
            list-style: disc
        }

        .typo-ol,
        .typo ol {
            list-style: decimal;
            margin-left: 1.9em
        }

        .typo-ol ol,
        .typo-ol ul,
        .typo-ul ol,
        .typo-ul ul,
        .typo li ol,
        .typo li ul {
            margin-bottom: .8em;
            margin-left: 2em
        }

        .typo-ol ul,
        .typo-ul ul,
        .typo li ul {
            list-style: circle
        }

        .typo-table td,
        .typo-table th,
        .typo table caption,
        .typo table td,
        .typo table th {
            border: 1px solid #ddd;
            padding: .5em 1em;
            color: #666
        }

        .typo-table th,
        .typo table th {
            background: #fbfbfb
        }

        .typo-table thead th,
        .typo table thead th {
            background: hsla(0, 0%, 95%, .7)
        }

        .typo table caption {
            border-bottom: none
        }

        .typo-input,
        .typo-textarea {
            -webkit-appearance: none;
            border-radius: 0
        }

        .typo-em,
        .typo em,
        caption,
        legend {
            color: #000;
            font-weight: inherit
        }

        .typo-em {
            position: relative
        }

        .typo-em:after {
            position: absolute;
            top: .65em;
            left: 0;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            content: "\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB"
        }

        .typo img {
            max-width: 100%
        }

        .common-content {
            font-weight: 400;
            color: #353535;
            line-height: 1.75rem;
            white-space: normal;
            word-break: normal;
            font-size: 1rem
        }

        .common-content img {
            display: block;
            max-width: 100%;
            background-color: #eee
        }

        .common-content audio,
        .common-content video {
            width: 100%;
            background-color: #eee
        }

        .common-content center,
        .common-content font {
            margin-top: 1rem;
            display: inline-block
        }

        .common-content center {
            width: 100%
        }

        .common-content pre {
            margin-top: 1rem;
            padding-left: 0;
            padding-right: 0;
            position: relative;
            overflow: hidden
        }

        .common-content pre code {
            font-size: .8rem;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding-left: 1rem;
            padding-right: 1rem;
            overflow-x: auto
        }

        .common-content hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        .common-content b,
        .common-content h1,
        .common-content h2,
        .common-content h3,
        .common-content h4,
        .common-content h5,
        .common-content strong {
            font-weight: 700
        }

        .common-content h1,
        .common-content h2 {
            font-size: 1.125rem;
            margin-bottom: .45rem
        }

        .common-content h3,
        .common-content h4,
        .common-content h5 {
            font-size: 1rem;
            margin-bottom: .45rem
        }

        .common-content p {
            font-weight: 400;
            color: #353535;
            margin-top: .15rem
        }

        .common-content .orange {
            color: #ff5a05
        }

        .common-content .reference {
            font-size: 1rem;
            color: #888
        }

        .custom-rich-content h1 {
            margin-top: 0;
            font-weight: 400;
            font-size: 15.25px;
            border-bottom: 1px solid #eee;
            line-height: 2.8
        }

        .custom-rich-content li,
        .custom-rich-content p {
            font-size: 14px;
            color: #888;
            line-height: 1.6
        }

        table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        table.hljs-ln,
        table.hljs-ln tbody,
        table.hljs-ln td,
        table.hljs-ln tr {
            box-sizing: border-box
        }

        table.hljs-ln td {
            padding: 0;
            border: 0
        }

        table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            user-select: none
        }

        table.hljs-ln td.hljs-ln-code,
        table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            font-size: 12px;
            line-height: 20px;
            vertical-align: top
        }

        table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            color: #24292e;
            word-wrap: normal;
            white-space: pre
        }

        video::-webkit-media-controls {
            overflow: hidden !important
        }

        video::-webkit-media-controls-enclosure {
            width: calc(100% + 32px);
            margin-left: auto
        }

        ._29HP61GA_0 {
            max-width:800px;
            margin:0 auto;
            margin-bottom: 20px;
            font-weight: 400;
            color: #353535;
            line-height: 1.76;
            white-space: normal;
            word-break: normal;
            font-size: 17px;
            -webkit-transition: background-color .3s ease;
            transition: background-color .3s ease
        }

        ._29HP61GA_0 .MathJax_Display {
            overflow: auto
        }

        ._29HP61GA_0 .poster {
            position: fixed;
            left: -10000px;
            top: -10000px;
            overflow: hidden;
            padding: 1rem;
            background: #ececec
        }

        ._29HP61GA_0 .richcontent-pre-copy {
            font-size: 13px;
            color: #888;
            position: absolute;
            right: 1em;
            top: .5em;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 .richcontent-pre-copy .iconfont {
            font-size: 12px;
            margin-right: .2em
        }

        ._29HP61GA_0 a {
            color: #fa8919;
            border-bottom: 1px solid #fa8919
        }

        ._29HP61GA_0 img {
            display: block;
            max-width: 100%;
            position: relative;
            left: 50%;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            background-color: #eee;
            vertical-align: top;
            border-radius: 0
        }

        ._29HP61GA_0 audio,
        ._29HP61GA_0 video {
            width: 100%;
            background-color: #eee
        }

        ._29HP61GA_0 pre {
            margin-top: 16px;
            padding: 34px 0 0;
            margin-bottom: 30px;
            position: relative;
            border-radius: 6px;
            background: rgba(246, 247, 251, .749);
            border: 0
        }

        ._29HP61GA_0 pre code {
            font-size: 12px;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            margin-left: 16px;
            margin-right: 16px;
            overflow-x: scroll
        }

        ._29HP61GA_0 pre code:after {
            content: "";
            height: 30px;
            width: 100%;
            display: block
        }

        ._29HP61GA_0 hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        ._29HP61GA_0 h1,
        ._29HP61GA_0 h2,
        ._29HP61GA_0 h3,
        ._29HP61GA_0 h4,
        ._29HP61GA_0 h5 {
            margin-bottom: 20px;
            margin-top: 0;
            font-weight: 700
        }

        ._29HP61GA_0 b,
        ._29HP61GA_0 strong {
            font-weight: 700
        }

        ._29HP61GA_0 h1 {
            font-size: 21px
        }

        ._29HP61GA_0 h2 {
            font-size: 20px
        }

        ._29HP61GA_0 h3 {
            font-size: 19px
        }

        ._29HP61GA_0 h4 {
            font-size: 18px
        }

        ._29HP61GA_0 h5 {
            font-size: 17px
        }

        ._29HP61GA_0 center,
        ._29HP61GA_0 p {
            font-weight: 400;
            color: #353535;
            margin-top: 0;
            margin-bottom: 30px;
            word-break: break-word
        }

        ._29HP61GA_0 center {
            text-align: center
        }

        ._29HP61GA_0 blockquote {
            margin-top: 0;
            margin-bottom: 34px;
            border-left: 3px solid #e8e8e8;
            padding-left: 17px;
            color: #353535
        }

        ._29HP61GA_0 blockquote p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol,
        ._29HP61GA_0 ul {
            margin-bottom: 30px
        }

        ._29HP61GA_0 ol p,
        ._29HP61GA_0 ul p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol {
            list-style: decimal;
            margin-left: 20px
        }

        ._29HP61GA_0 ul li {
            padding-left: 17px;
            position: relative;
            margin-bottom: 10px
        }

        ._29HP61GA_0 ul li:after {
            content: "";
            height: 6px;
            width: 6px;
            border-radius: 50%;
            background: #353535;
            position: absolute;
            top: 10px;
            left: 0
        }

        ._29HP61GA_0 .orange {
            color: #fa8919
        }

        ._29HP61GA_0 .reference {
            color: #888
        }

        ._29HP61GA_0 .m-right {
            text-align: right
        }

        ._29HP61GA_0 .m-center {
            text-align: center;
            display: block
        }

        ._29HP61GA_0 .m-gray {
            color: #888
        }

        ._29HP61GA_0 .m-small {
            font-size: 15px
        }

        ._29HP61GA_0 table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        ._29HP61GA_0 table.hljs-ln,
        ._29HP61GA_0 table.hljs-ln tbody,
        ._29HP61GA_0 table.hljs-ln td,
        ._29HP61GA_0 table.hljs-ln tr {
            -webkit-box-sizing: border-box;
            box-sizing: border-box
        }

        ._29HP61GA_0 table.hljs-ln td {
            padding: 0;
            border: 0
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            font-size: 12px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code,
        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            line-height: 20px;
            vertical-align: top
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            font-size: 13px;
            color: #666;
            word-wrap: normal;
            white-space: pre
        }

    </style>
</head>
<body>
<div class="_29HP61GA_0">
<h1>30-Coroutinesï¼šåä½œå¼çš„äº¤å‰è°ƒåº¦æ‰§è¡Œ</h1>
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å´å’ç‚œã€‚</p><p>ä»Šå¤©æ˜¯æˆ‘ä»¬æœªæ¥ç¯‡çš„æœ€åä¸€è®²ï¼Œä¹Ÿæ˜¯è¿™ä¸ªä¸“æ æ­£æ–‡å†…å®¹çš„æœ€åä¸€ç¯‡äº†ã€‚æˆ‘ä»¬è®¨è®º C++20 é‡Œçš„åˆä¸€ä¸ªéå¸¸é‡è¦çš„æ–°åŠŸèƒ½â€”â€”åç¨‹ Coroutinesã€‚</p><h2>ä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿ</h2><p>åç¨‹æ˜¯ä¸€ä¸ªå¾ˆæ—©å°±è¢«æå‡ºçš„ç¼–ç¨‹æ¦‚å¿µã€‚æ ¹æ®é«˜å¾·çº³çš„æè¿°ï¼Œåç¨‹çš„æ¦‚å¿µåœ¨ 1958 å¹´å°±è¢«æå‡ºäº†ã€‚ä¸è¿‡ï¼Œå®ƒåœ¨ä¸»æµç¼–ç¨‹è¯­è¨€ä¸­å¾—åˆ°çš„æ”¯æŒä¸é‚£ä¹ˆå¥½ï¼Œå› è€Œä½ å¾ˆå¯èƒ½å¯¹å®ƒå¹¶ä¸ç†Ÿæ‚‰å§ã€‚</p><p>å¦‚æœæŸ¥é˜…ç»´åŸºç™¾ç§‘ï¼Œä½ å¯ä»¥çœ‹åˆ°ä¸‹é¢è¿™æ ·çš„å®šä¹‰ <span class="orange">[1]</span>ï¼š</p><blockquote>
<p>åç¨‹æ˜¯è®¡ç®—æœºç¨‹åºçš„â¼€ç±»ç»„ä»¶ï¼Œæ¨â¼´äº†åä½œå¼å¤šä»»åŠ¡çš„â¼¦ç¨‹åºï¼Œå…è®¸æ‰§â¾è¢«æŒ‚èµ·ä¸è¢«æ¢å¤ã€‚ç›¸å¯¹â¼¦ä¾‹ç¨‹â½½â¾”ï¼Œåç¨‹æ›´ä¸ºâ¼€èˆ¬å’Œçµæ´»â€¦â€¦</p>
</blockquote><p>ç­‰å­¦å®Œäº†è¿™ä¸€è®²ï¼Œä¹Ÿè®¸ä½ å¯ä»¥æ˜ç™½è¿™æ®µè¯çš„æ„æ€ã€‚ä½†å¯¹ä¸äº†è§£åç¨‹çš„äººæ¥è¯´ï¼Œä¼°è®¡åªèƒ½åæ§½ä¸€å¥äº†ï¼Œè¿™æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿ</p><p><img src="https://static001.geekbang.org/resource/image/4d/f9/4d4fb4a1c16edb1087d934cd1bb7eef9.png" alt="" title="å›¾ç‰‡æºè‡ªç½‘ç»œ"></p><p>å¾ˆé—æ†¾ï¼Œåœ¨ C++ é‡Œçš„æ ‡å‡†åç¨‹æœ‰ç‚¹å°å¤æ‚ã€‚æˆ‘ä»¬è¿˜æ˜¯ä»â€¦â€¦Python å¼€å§‹ã€‚</p><pre><code class="language-python">def fibonacci():
    a = 0
    b = 1
    while True:
        yield b
        a, b = b, a + b
</code></pre><p>å³ä½¿ä½ æ²¡å­¦è¿‡ Pythonï¼Œä¸Šé¢è¿™ä¸ªç”Ÿæˆæ–æ³¢é‚£å¥‘æ•°åˆ—çš„ä»£ç åº”è¯¥ä¹Ÿä¸éš¾ç†è§£ã€‚å”¯ä¸€çœ‹èµ·æ¥è®©äººä¼šè§‰å¾—æœ‰ç‚¹å¥‡æ€ªçš„åº”è¯¥å°±æ˜¯é‚£ä¸ª <code>yield</code> äº†ã€‚è¿™ç§å†™æ³•åœ¨ Python é‡Œå«åšâ€œç”Ÿæˆå™¨â€ï¼ˆgeneratorï¼‰ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªå¯è¿­ä»£çš„å¯¹è±¡ï¼Œæ¯æ¬¡è¿­ä»£å°±èƒ½å¾—åˆ°ä¸€ä¸ª yield å‡ºæ¥çš„ç»“æœã€‚è¿™å°±æ˜¯ä¸€ç§å¾ˆå¸¸è§çš„åç¨‹å½¢å¼äº†ã€‚</p><!-- [[[read_end]]] --><p>å¦‚ä½•ä½¿ç”¨è¿™ä¸ªç”Ÿæˆå™¨ï¼Œè¯·çœ‹ä¸‹é¢çš„ä»£ç ï¼š</p><pre><code class="language-python"># æ‰“å°å¤´ 20 é¡¹
for i in islice(fibonacci(), 20):
    print(i)

# æ‰“å°å°äº 10000 çš„æ•°åˆ—é¡¹
for i in takewhile(
        lambda x: x &lt; 10000,
        fibonacci()):
    print(i)
</code></pre><p>è¿™äº›ä»£ç å¾ˆå®¹æ˜“ç†è§£ï¼š<code>islice</code> ç›¸å½“äº <a href="https://time.geekbang.org/column/article/195553">[ç¬¬ 29 è®²]</a> ä¸­çš„ <code>take</code>ï¼Œå–ä¸€ä¸ªèŒƒå›´çš„å¤´è‹¥å¹²é¡¹ï¼›<code>takewhile</code> åˆ™åœ¨èŒƒå›´ä¸­é€é¡¹å–å‡ºå†…å®¹ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªå‚æ•°çš„æ¡ä»¶ä¸èƒ½è¢«æ»¡è¶³ã€‚ä¸¤ä¸ªå‡½æ•°çš„ç»“æœéƒ½å¯ä»¥è¢«çœ‹ä½œæ˜¯ C++ ä¸­çš„è§†å›¾ã€‚</p><p>æˆ‘ä»¬å”¯ä¸€éœ€è¦æçš„æ˜¯ï¼Œåœ¨ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ<code>fibonacci</code> å’Œå®ƒçš„è°ƒç”¨ä»£ç æ˜¯äº¤å‰æ‰§è¡Œçš„ã€‚ä¸‹é¢æˆ‘ä»¬ç”¨ä»£ç è¡ŒåŠ æ³¨é‡Šçš„æ–¹å¼æ ‡ä¸€ä¸‹ï¼š</p><pre><code class="language-python">a = 0  # fibonacci()
b = 0  # fibonacci()
yield b  # fibonacci()
print(i)  # è°ƒç”¨è€…
a, b = 1, 0 + 1  # fibonacci()
yield b  # fibonacci()
print(i)  # è°ƒç”¨è€…
a, b = 1, 1 + 1  # fibonacci()
yield b  # fibonacci()
print(i)  # è°ƒç”¨è€…
a, b = 2, 1 + 2  # fibonacci()
yield b  # fibonacci()
print(i)  # è°ƒç”¨è€…
â€¦
</code></pre><p>å­¦åˆ°è¿™å„¿çš„åŒå­¦åº”è¯¥éƒ½çŸ¥é“æˆ‘ä»¬åœ¨ C++ é‡Œæ€ä¹ˆå®Œæˆç±»ä¼¼çš„åŠŸèƒ½å§ï¼Ÿæˆ‘å°±ä¸è®²è§£äº†ï¼Œç›´æ¥ç»™å‡ºå¯å·¥ä½œçš„ä»£ç ã€‚è¿™æ˜¯å¯¹åº”çš„ <code>fibonacci</code> çš„å®šä¹‰ï¼š</p><pre><code class="language-c++">#include &lt;stddef.h&gt;
#include &lt;stdint.h&gt;

class fibonacci {
public:
  class sentinel;
  class iterator;
  iterator begin() noexcept;
  sentinel end() noexcept;
};

class fibonacci::sentinel {};

class fibonacci::iterator {
public:
  // Required to satisfy iterator
  // concept
  typedef ptrdiff_t difference_type;
  typedef uint64_t value_type;
  typedef const uint64_t* pointer;
  typedef const uint64_t&amp; reference;
  typedef std::input_iterator_tag
    iterator_category;

  value_type operator*() const
  {
    return b_;
  }
  pointer operator-&gt;() const
  {
    return &amp;b_;
  }
  iterator&amp; operator++()
  {
    auto tmp = a_;
    a_ = b_;
    b_ += tmp;
    return *this;
  }
  iterator operator++(int)
  {
    auto tmp = *this;
    ++*this;
    return tmp;
  }
  bool
  operator==(const sentinel&amp;) const
  {
    return false;
  }
  bool
  operator!=(const sentinel&amp;) const
  {
    return true;
  }

private:
  uint64_t a_{0};
  uint64_t b_{1};
};

// sentinel needs to be
// equality_comparable_with iterator
bool operator==(
  const fibonacci::sentinel&amp; lhs,
  const fibonacci::iterator&amp; rhs)
{
  return rhs == lhs;
}
bool operator!=(
  const fibonacci::sentinel&amp; lhs,
  const fibonacci::iterator&amp; rhs)
{
  return rhs != lhs;
}

inline fibonacci::iterator
fibonacci::begin() noexcept
{
  return iterator();
}

inline fibonacci::sentinel
fibonacci::end() noexcept
{
  return sentinel();
}
</code></pre><p>è°ƒç”¨ä»£ç è·Ÿ Python çš„ç›¸ä¼¼ï¼š</p><pre><code class="language-c++">// æ‰“å°å¤´ 20 é¡¹
for (auto i :
     fibonacci() | take(20)) {
  cout &lt;&lt; i &lt;&lt; endl;
}

// æ‰“å°å°äº 10000 çš„æ•°åˆ—é¡¹
for (auto i :
     fibonacci() |
       take_while([](uint64_t x) {
         return x &lt; 10000;
       })) {
  cout &lt;&lt; i &lt;&lt; endl;
}
</code></pre><p>è¿™ä¼¼ä¹è¿˜è¡Œã€‚ä½† <code>fibonacci</code> çš„å®šä¹‰å·®å¼‚å°±å¤§äº†ï¼šåœ¨ Python é‡Œæ˜¯ 6 è¡Œæœ‰æ•ˆä»£ç ï¼Œåœ¨ C++ é‡Œæ˜¯ 53 è¡Œã€‚C++ çš„ç”Ÿäº§ç‡ä¼¼ä¹æœ‰ç‚¹ä½å•Šâ€¦â€¦</p><h2>C++20 åç¨‹</h2><p>C++20 åç¨‹çš„åŸºç¡€æ˜¯å¾®è½¯æå‡ºçš„ Coroutines TSï¼ˆå¯æŸ¥çœ‹å·¥ä½œè‰æ¡ˆ <span class="orange">[2]</span>ï¼‰ï¼Œå®ƒåœ¨ 2019 å¹´ 7 æœˆè¢«æ‰¹å‡†åŠ å…¥åˆ° C++20 è‰æ¡ˆä¸­ã€‚ç›®å‰ï¼ŒMSVC å’Œ Clang å·²ç»æ”¯æŒåç¨‹ã€‚ä¸è¿‡ï¼Œéœ€è¦æä¸€ä¸‹çš„æ˜¯ï¼Œç›®å‰è¢«æ ‡å‡†åŒ–çš„åªæ˜¯åç¨‹çš„åº•å±‚è¯­è¨€æ”¯æŒï¼Œè€Œä¸æ˜¯ä¸Šå±‚çš„é«˜çº§å°è£…ï¼›ç¨åï¼Œæˆ‘ä»¬ä¼šå›åˆ°è¿™ä¸ªè¯é¢˜ã€‚</p><p>åç¨‹å¯ä»¥æœ‰å¾ˆå¤šä¸åŒçš„ç”¨é€”ï¼Œä¸‹é¢åˆ—ä¸¾äº†å‡ ç§å¸¸è§æƒ…å†µï¼š</p><ul>
<li>ç”Ÿæˆå™¨</li>
<li>å¼‚æ­¥ I/O</li>
<li>æƒ°æ€§æ±‚å€¼</li>
<li>äº‹ä»¶é©±åŠ¨åº”ç”¨</li>
</ul><p>è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦è¿˜æ˜¯æ²¿ç”¨ç”Ÿæˆå™¨çš„ä¾‹å­ï¼Œå‘ä½ å±•ç¤ºåç¨‹çš„åŸºæœ¬ç”¨æ³•ã€‚å¼‚æ­¥ I/O åº”å½“åœ¨åç¨‹å¾—åˆ°å¹¿æ³›é‡‡ç”¨ä¹‹åï¼Œæˆä¸ºæœ€èƒ½æœ‰æ˜æ˜¾æ”¶ç›Šçš„ä½¿ç”¨åœºæ™¯ï¼›ä½†ç›®å‰ï¼Œå°±æˆ‘çœ‹åˆ°çš„ï¼Œåªæœ‰ Windows å¹³å°ä¸Šæœ‰è¾ƒå¥½çš„æ”¯æŒâ€”â€”å¾®è½¯ç›®å‰è¿˜æ˜¯åšäº†å¾ˆå¤šåŠªåŠ›çš„ã€‚</p><p>å›åˆ° Coroutinesã€‚æˆ‘ä»¬ä»Šå¤©é‡‡ç”¨ Coroutines TS ä¸­çš„å†™æ³•ï¼ŒåŒ…æ‹¬ <code>std::experimental</code> åç©ºé—´ï¼Œä»¥ç¡®ä¿ä½ å¯ä»¥åœ¨ MSVC å’Œ Clang ä¸‹ç¼–è¯‘ä»£ç ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹åç¨‹ç›¸å…³çš„æ–°å…³é”®å­—ï¼Œæœ‰ä¸‹é¢ä¸‰ä¸ªï¼š</p><ul>
<li><code>co_await</code></li>
<li><code>co_yield</code></li>
<li><code>co_return</code></li>
</ul><p>è¿™ä¸‰ä¸ªå…³é”®å­—æœ€åˆæ˜¯æ²¡æœ‰ <code>co_</code> å‰ç¼€çš„ï¼Œä½†è€ƒè™‘åˆ° <code>await</code>ã€<code>yield</code> å·²ç»åœ¨å¾ˆå¤šä»£ç é‡Œå‡ºç°ï¼Œå°±æ”¹æˆäº†ç›®å‰è¿™ä¸ªæ ·å­ã€‚åŒæ—¶ï¼Œ<code>return</code> å’Œ <code>co_return</code> ä¹Ÿä½œå‡ºäº†æ˜ç¡®çš„åŒºåˆ†ï¼šä¸€ä¸ªåç¨‹é‡Œåªèƒ½ä½¿ç”¨ <code>co_return</code>ï¼Œä¸èƒ½ä½¿ç”¨ <code>return</code>ã€‚è¿™ä¸‰ä¸ªå…³é”®å­—åªè¦æœ‰ä¸€ä¸ªå‡ºç°åœ¨å‡½æ•°ä¸­ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯ä¸€ä¸ªåç¨‹äº†â€”â€”ä»å¤–éƒ¨åˆ™çœ‹ä¸å‡ºæ¥ï¼Œæ²¡æœ‰ç”¨å…¶ä»–è¯­è¨€å¸¸ç”¨çš„ <code>async</code> å…³é”®å­—æ¥æ ‡è®°ï¼ˆ<code>async</code> ä¹Ÿå·²ç»æœ‰å…¶ä»–ç”¨é€”äº†ï¼Œè§ <a href="https://time.geekbang.org/column/article/186689">[ç¬¬ 19 è®²]</a>ï¼‰ã€‚C++ è®¤ä¸ºä¸€ä¸ªå‡½æ•°æ˜¯å¦æ˜¯ä¸€ä¸ªåç¨‹æ˜¯ä¸€ä¸ªå®ç°ç»†èŠ‚ï¼Œä¸æ˜¯å¯¹å¤–æ¥å£çš„ä¸€éƒ¨åˆ†ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹ç”¨åç¨‹å®ç°çš„ <code>fibonacci</code> é•¿ä»€ä¹ˆæ ·å­ï¼š</p><pre><code class="language-c++">uint64_resumable fibonacci()
{
  uint64_t a = 0;
  uint64_t b = 1;
  while (true) {
    co_yield b;
    auto tmp = a;
    a = b;
    b += tmp;
  }
}
</code></pre><p>è¿™ä¸ªå½¢å¼è·Ÿ Python çš„éå¸¸ç›¸ä¼¼äº†å§ï¼Œä¹Ÿéå¸¸ç®€æ´ã€‚æˆ‘ä»¬ç¨åå†è®¨è®º <code>uint64_resumable</code> çš„å®šä¹‰ï¼Œå…ˆçœ‹ä¸€ä¸‹è°ƒç”¨ä»£ç çš„æ ·å­ï¼š</p><pre><code class="language-c++">auto res = fibonacci();
while (res.resume()) {
  auto i = res.get();
  if (i &gt;= 10000) {
    break;
  }
  cout &lt;&lt; i &lt;&lt; endl;
}
</code></pre><p>è¿™ä¸ªä»£ç ä¹Ÿéå¸¸ç®€å•ï¼Œä½†æˆ‘ä»¬éœ€è¦ç•™æ„ <code>resume</code> å’Œ <code>get</code> ä¸¤ä¸ªå‡½æ•°è°ƒç”¨â€”â€”è¿™å°±æ˜¯æˆ‘ä»¬çš„ <code>uint64_resumable</code> ç±»å‹éœ€è¦æä¾›çš„æ¥å£äº†ã€‚</p><h3>co_awaitã€co_yieldã€co_return å’Œåç¨‹æ§åˆ¶</h3><p>åœ¨è®¨è®ºè¯¥å¦‚ä½•å®šä¹‰ <code>uint64_resumable</code> ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè®¨è®ºä¸€ä¸‹åç¨‹çš„è¿™ä¸‰ä¸ªæ–°å…³é”®å­—ã€‚</p><p>é¦–å…ˆæ˜¯ <code>co_await</code>ã€‚å¯¹äºä¸‹é¢è¿™æ ·ä¸€ä¸ªè¡¨è¾¾å¼ï¼š</p><pre><code class="language-c++">auto result = co_await è¡¨è¾¾å¼;
</code></pre><p>ç¼–è¯‘å™¨ä¼šæŠŠå®ƒç†è§£ä¸ºï¼š</p><pre><code class="language-c++">auto&amp;&amp; __a = è¡¨è¾¾å¼;
if (!__a.await_ready()) {
  __a.await_suspend(åç¨‹å¥æŸ„);
  // æŒ‚èµ·/æ¢å¤ç‚¹
}
auto result = __a.await_resume();
</code></pre><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œâ€œè¡¨è¾¾å¼â€éœ€è¦æ”¯æŒ <code>await_ready</code>ã€<code>await_suspend</code> å’Œ <code>await_resume</code> ä¸‰ä¸ªæ¥å£ã€‚å¦‚æœ <code>await_ready()</code> è¿”å›çœŸï¼Œå°±ä»£è¡¨ä¸éœ€è¦çœŸæ­£æŒ‚èµ·ï¼Œç›´æ¥è¿”å›åé¢çš„ç»“æœå°±å¯ä»¥ï¼›å¦åˆ™ï¼Œæ‰§è¡Œ <code>await_suspend</code> ä¹‹åå³æŒ‚èµ·åç¨‹ï¼Œç­‰å¾…åç¨‹è¢«å”¤é†’ä¹‹åå†è¿”å› <code>await_resume()</code> çš„ç»“æœã€‚è¿™æ ·ä¸€ä¸ªè¡¨è¾¾å¼è¢«ç§°ä½œæ˜¯ä¸ª awaitableã€‚</p><p>æ ‡å‡†é‡Œå®šä¹‰äº†ä¸¤ä¸ª awaitableï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class="language-c++">struct suspend_always {
  bool await_ready() const noexcept
  {
    return false;
  }
  void await_suspend(
    coroutine_handle&lt;&gt;)
    const noexcept {}
  void await_resume()
    const noexcept {}
};

struct suspend_never {
  bool await_ready() const noexcept
  {
    return true;
  }
  void await_suspend(
    coroutine_handle&lt;&gt;)
    const noexcept {}
  void await_resume()
    const noexcept {}
};
</code></pre><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>suspend_always</code> æ°¸è¿œå‘Šè¯‰è°ƒç”¨è€…éœ€è¦æŒ‚èµ·ï¼Œè€Œ <code>suspend_never</code> åˆ™æ°¸è¿œå‘Šè¯‰è°ƒç”¨è€…ä¸éœ€è¦æŒ‚èµ·ã€‚ä¸¤è€…çš„ <code>await_suspend</code> å’Œ <code>await_resume</code> éƒ½æ˜¯å¹³å‡¡å®ç°ï¼Œä¸åšä»»ä½•å®é™…çš„äº‹æƒ…ã€‚ä¸€ä¸ª awaitable å¯ä»¥è‡ªè¡Œå®ç°è¿™äº›æ¥å£ï¼Œä»¥å®šåˆ¶æŒ‚èµ·ä¹‹å‰å’Œæ¢å¤ä¹‹åéœ€è¦æ‰§è¡Œçš„æ“ä½œã€‚</p><p>ä¸Šé¢çš„ <code>coroutine_handle</code> æ˜¯ C++ æ ‡å‡†åº“æä¾›çš„ç±»æ¨¡æ¿ã€‚è¿™ä¸ªç±»æ˜¯ç”¨æˆ·ä»£ç è·Ÿç³»ç»Ÿåç¨‹è°ƒåº¦çœŸæ­£äº¤äº’çš„åœ°æ–¹ï¼Œæœ‰ä¸‹é¢è¿™äº›æˆå‘˜å‡½æ•°æˆ‘ä»¬ç­‰ä¼šå°±ä¼šç”¨åˆ°ï¼š</p><ul>
<li><code>destroy</code>ï¼šé”€æ¯åç¨‹</li>
<li><code>done</code>ï¼šåˆ¤æ–­åç¨‹æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆ</li>
<li><code>resume</code>ï¼šè®©åç¨‹æ¢å¤æ‰§è¡Œ</li>
<li><code>promise</code>ï¼šè·å¾—åç¨‹ç›¸å…³çš„ promise å¯¹è±¡ï¼ˆå’Œ <a href="https://time.geekbang.org/column/article/186689">[ç¬¬ 19 è®²]</a> ä¸­çš„â€œæ‰¿è¯ºé‡â€æœ‰ç‚¹ç›¸ä¼¼ï¼Œæ˜¯åç¨‹å’Œè°ƒç”¨è€…çš„ä¸»è¦äº¤äº’å¯¹è±¡ï¼›ä¸€èˆ¬ç±»å‹åç§°ä¸º <code>promise_type</code>ï¼‰</li>
<li><code>from_promise</code>ï¼ˆé™æ€ï¼‰ï¼šé€šè¿‡ promise å¯¹è±¡çš„å¼•ç”¨æ¥ç”Ÿæˆä¸€ä¸ªåç¨‹å¥æŸ„</li>
</ul><p>åç¨‹çš„æ‰§è¡Œè¿‡ç¨‹å¤§è‡´æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š</p><ol>
<li>ä¸ºåç¨‹è°ƒç”¨åˆ†é…ä¸€ä¸ªåç¨‹å¸§ï¼Œå«åç¨‹è°ƒç”¨çš„å‚æ•°ã€å˜é‡ã€çŠ¶æ€ã€promise å¯¹è±¡ç­‰æ‰€éœ€çš„ç©ºé—´ã€‚</li>
<li>è°ƒç”¨ <code>promise.get_return_object()</code>ï¼Œè¿”å›å€¼ä¼šåœ¨åç¨‹ç¬¬ä¸€æ¬¡æŒ‚èµ·æ—¶è¿”å›ç»™åç¨‹çš„è°ƒç”¨è€…ã€‚</li>
<li>æ‰§è¡Œ <code>co_await promise.initial_suspsend()</code>ï¼›æ ¹æ®ä¸Šé¢å¯¹ <code>co_await</code> è¯­ä¹‰çš„æè¿°ï¼Œåç¨‹å¯èƒ½åœ¨æ­¤ç¬¬ä¸€æ¬¡æŒ‚èµ·ï¼ˆä½†ä¹Ÿå¯èƒ½æ­¤æ—¶ä¸æŒ‚èµ·ï¼Œåœ¨åé¢çš„åç¨‹ä½“æ‰§è¡Œè¿‡ç¨‹ä¸­æŒ‚èµ·ï¼‰ã€‚</li>
<li>æ‰§è¡Œåç¨‹ä½“ä¸­çš„è¯­å¥ï¼Œä¸­é—´å¯èƒ½æœ‰æŒ‚èµ·å’Œæ¢å¤ï¼›å¦‚æœæœŸé—´å‘ç”Ÿå¼‚å¸¸æ²¡æœ‰åœ¨åç¨‹ä½“ä¸­å¤„ç†ï¼Œåˆ™è°ƒç”¨ <code>promise.unhandled_exception()</code>ã€‚</li>
<li>å½“åç¨‹æ‰§è¡Œåˆ°åº•ï¼Œæˆ–è€…æ‰§è¡Œåˆ° <code>co_return</code> è¯­å¥æ—¶ï¼Œä¼šæ ¹æ®æ˜¯å¦æœ‰é void çš„è¿”å›å€¼ï¼Œè°ƒç”¨ <code>promise.return_value(â€¦)</code> æˆ– <code>promise.return_void()</code>ï¼Œç„¶åæ‰§è¡Œ <code>co_await promise.final_suspsend()</code>ã€‚</li>
</ol><p>ç”¨ä»£ç å¯ä»¥å¤§è‡´è¡¨ç¤ºå¦‚ä¸‹ï¼š</p><pre><code class="language-c++">  frame = operator new(â€¦);
  promise_type&amp; promise =
    frame-&gt;promise;

  // åœ¨åˆæ¬¡æŒ‚èµ·æ—¶è¿”å›ç»™è°ƒç”¨è€…
  auto return_value =
    promise.get_return_object();

  co_await promise
    .initial_suspsend();
  try {
    æ‰§è¡Œåç¨‹ä½“;
    å¯èƒ½è¢« co_waitã€co_yield æŒ‚èµ·;
    æ¢å¤åç»§ç»­æ‰§è¡Œï¼Œç›´åˆ° co_return;
  }
  catch (...) {
    promise.unhandled_exception();
  }

final_suspend:
  co_await promise.final_suspsend();
</code></pre><p>ä¸Šé¢æè¿°äº† <code>co_await</code> å’Œ <code>co_return</code>ï¼Œé‚£ <code>co_yield</code> å‘¢ï¼Ÿä¹Ÿå¾ˆç®€å•ï¼Œ<code>co_yield è¡¨è¾¾å¼</code> ç­‰ä»·äºï¼š</p><pre><code class="language-c++">co_await promise.yield_value(è¡¨è¾¾å¼);
</code></pre><h3>å®šä¹‰ <code>uint64_resumable</code></h3><p>äº†è§£äº†ä¸Šè¿°çŸ¥è¯†ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å±•ç¤ºä¸€ä¸‹ <code>uint64_resumable</code> çš„å®šä¹‰äº†ï¼š</p><pre><code class="language-c++">class uint64_resumable {
public:
  struct promise_type {â€¦};

  using coro_handle =
    coroutine_handle&lt;promise_type&gt;;
  explicit uint64_resumable(
    coro_handle handle)
    : handle_(handle)
  {
  }
  ~uint64_resumable()
  {
    handle_.destroy();
  }
  uint64_resumable(
    const uint64_resumable&amp;) =
    delete;
  uint64_resumable(
    uint64_resumable&amp;&amp;) = default;
  bool resume();
  uint64_t get();

private:
  coro_handle handle_;
};
</code></pre><p>è¿™ä¸ªä»£ç ç›¸å½“ç®€å•ï¼Œæˆ‘ä»¬çš„ç»“æ„å†…éƒ¨æœ‰ä¸ª <code>promise_type</code>ï¼ˆä¸‹é¢ä¼šå®šä¹‰ï¼‰ï¼Œè€Œç§æœ‰æˆå‘˜åªæœ‰ä¸€ä¸ªåç¨‹å¥æŸ„ã€‚åç¨‹æ„é€ éœ€è¦ä¸€ä¸ªåç¨‹å¥æŸ„ï¼Œææ„æ—¶å°†ä½¿ç”¨åç¨‹å¥æŸ„æ¥é”€æ¯åç¨‹ï¼›ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å…è®¸ç»“æ„è¢«ç§»åŠ¨ï¼Œä½†ä¸å¯å¤åˆ¶ï¼ˆä»¥å…é‡å¤è°ƒç”¨ <code>handle_.destroy()</code>ï¼‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿™ä¸ªç»“æ„åªæä¾›äº†è°ƒç”¨è€…éœ€è¦çš„ <code>resume</code> å’Œ <code>get</code> æˆå‘˜å‡½æ•°ï¼Œåˆ†åˆ«å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code class="language-c++">bool uint64_resumable::resume()
{
  if (!handle_.done()) {
    handle_.resume();
  }
  return !handle_.done();
}

uint64_t uint64_resumable::get()
{
  return handle_.promise().value_;
}
</code></pre><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>resume</code> ä¼šåˆ¤æ–­åç¨‹æ˜¯å¦å·²ç»ç»“æŸï¼Œæ²¡ç»“æŸå°±æ¢å¤åç¨‹çš„æ‰§è¡Œï¼›å½“åç¨‹å†æ¬¡æŒ‚èµ·æ—¶ï¼ˆè°ƒç”¨è€…æ¢å¤æ‰§è¡Œï¼‰ï¼Œè¿”å›åç¨‹æ˜¯å¦ä»åœ¨æ‰§è¡Œä¸­çš„çŠ¶æ€ã€‚è€Œ <code>get</code> ç®€å•åœ°è¿”å›å­˜å‚¨åœ¨ promise å¯¹è±¡ä¸­çš„æ•°å€¼ã€‚</p><p>ç°åœ¨æˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹ promise ç±»å‹äº†ï¼Œå®ƒé‡Œé¢æœ‰å¾ˆå¤šåç¨‹çš„å®šåˆ¶ç‚¹ï¼Œå¯ä»¥ä¿®æ”¹åç¨‹çš„è¡Œä¸ºï¼š</p><pre><code class="language-c++">struct promise_type {
  uint64_t value_;
  using coro_handle =
    coroutine_handle&lt;promise_type&gt;;
  auto get_return_object()
  {
    return uint64_resumable{
      coro_handle::from_promise(
        *this)};
  }
  constexpr auto initial_suspend()
  {
    return suspend_always();
  }
  constexpr auto final_suspend()
  {
    return suspend_always();
  }
  auto yield_value(uint64_t value)
  {
    value_ = value;
    return suspend_always();
  }
  void return_void() {}
  void unhandled_exception()
  {
    std::terminate();
  }
};
</code></pre><p>ç®€å•è§£è¯´ä¸€ä¸‹ï¼š</p><ul>
<li>ç»“æ„é‡Œé¢åªæœ‰ä¸€ä¸ªæ•°æ®æˆå‘˜ <code>value_</code>ï¼Œå­˜æ”¾ä¾› <code>uint64_resumable::get</code> å–ç”¨çš„æ•°å€¼ã€‚</li>
<li><code>get_return_object</code> æ˜¯ç¬¬ä¸€ä¸ªå®šåˆ¶ç‚¹ã€‚æˆ‘ä»¬å‰é¢æåˆ°è¿‡ï¼Œè°ƒç”¨åç¨‹çš„è¿”å›å€¼å°±æ˜¯ <code>get_return_object()</code> çš„ç»“æœã€‚æˆ‘ä»¬è¿™å„¿å°±æ˜¯ä½¿ç”¨ promise å¯¹è±¡æ¥æ„é€ ä¸€ä¸ª <code>uint64_resumable</code>ã€‚</li>
<li><code>initial_suspend</code> æ˜¯ç¬¬äºŒä¸ªå®šåˆ¶ç‚¹ã€‚æˆ‘ä»¬æ­¤å¤„è¿”å› <code>suspend_always()</code>ï¼Œå³åç¨‹ç«‹å³æŒ‚èµ·ï¼Œè°ƒç”¨è€…é©¬ä¸Šå¾—åˆ° <code>get_return_object()</code> çš„ç»“æœã€‚</li>
<li><code>final_suspend</code> æ˜¯ç¬¬ä¸‰ä¸ªå®šåˆ¶ç‚¹ã€‚æˆ‘ä»¬æ­¤å¤„è¿”å› <code>suspend_always()</code>ï¼Œå³ä½¿æ‰§è¡Œåˆ°äº† <code>co_return</code> è¯­å¥ï¼Œåç¨‹ä»å¤„äºæŒ‚èµ·çŠ¶æ€ã€‚å¦‚æœæˆ‘ä»¬è¿”å› <code>suspend_never()</code> çš„è¯ï¼Œé‚£ä¸€æ—¦æ‰§è¡Œäº† <code>co_return</code> æˆ–æ‰§è¡Œåˆ°åç¨‹ç»“æŸï¼Œåç¨‹å°±ä¼šè¢«é”€æ¯ï¼Œè¿åŒå·²åˆå§‹åŒ–çš„æœ¬åœ°å˜é‡å’Œ promiseï¼Œå¹¶é‡Šæ”¾åç¨‹å¸§å†…å­˜ã€‚</li>
<li><code>yield_value</code> æ˜¯ç¬¬å››ä¸ªå®šåˆ¶ç‚¹ã€‚æˆ‘ä»¬è¿™å„¿ä»…å¯¹ <code>value_</code> è¿›è¡Œèµ‹å€¼ï¼Œç„¶åè®©åç¨‹æŒ‚èµ·ï¼ˆæ‰§è¡Œæ§åˆ¶å›åˆ°è°ƒç”¨è€…ï¼‰ã€‚</li>
<li><code>return_void</code> æ˜¯ç¬¬äº”ä¸ªå®šåˆ¶ç‚¹ã€‚æˆ‘ä»¬çš„ä»£ç æ°¸ä¸è¿”å›ï¼Œè¿™å„¿æ— äº‹å¯åšã€‚</li>
<li><code>unhandled_exception</code> æ˜¯ç¬¬å…­ä¸ªå®šåˆ¶ç‚¹ã€‚æˆ‘ä»¬è¿™å„¿ä¹Ÿä¸åº”è¯¥å‘ç”Ÿä»»ä½•å¼‚å¸¸ï¼Œæ‰€ä»¥æˆ‘ä»¬ç®€å•åœ°è°ƒç”¨ <code>terminate</code> æ¥ç»ˆç»“ç¨‹åºçš„æ‰§è¡Œã€‚</li>
</ul><p>å¥½äº†ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†åç¨‹ç›¸å…³çš„æ‰€æœ‰å®šä¹‰ã€‚æœ‰æ²¡æœ‰è§‰å¾—è½»æ¾ç‚¹ï¼Ÿ</p><hr></hr><p>æ²¡æœ‰ï¼Ÿé‚£å°±å¯¹äº†ã€‚æ­£å¦‚æˆ‘åœ¨è¿™ä¸€èŠ‚å¼€å¤´è¯´çš„ï¼ŒC++20 æ ‡å‡†åŒ–çš„åªæ˜¯åç¨‹çš„åº•å±‚è¯­è¨€æ”¯æŒï¼ˆæˆ‘ä¸Šé¢è¿˜å¹¶ä¸æ˜¯ä¸€ä¸ªéå¸¸å®Œæ•´çš„æè¿°ï¼‰ã€‚è¦ç”¨è¿™äº›åº•å±‚ç›´æ¥å†™åº”ç”¨ä»£ç ï¼Œé‚£æ˜¯éå¸¸ç—›è‹¦çš„äº‹ã€‚è¿™äº›æ¥å£çš„ç›®æ ‡ç”¨æˆ·å®é™…ä¸Šä¹Ÿä¸æ˜¯æ™®é€šå¼€å‘è€…ï¼Œè€Œæ˜¯åº“çš„ä½œè€…ã€‚</p><p>å¹¸å¥½ï¼Œæˆ‘ä»¬å¹¶ä¸æ˜¯æ²¡æœ‰ä»»ä½•é«˜å±‚æŠ½è±¡ï¼Œè™½ç„¶è¿™äº›å®ç°ä¸â€œæ ‡å‡†â€ã€‚</p><h2>C++20 åç¨‹çš„é«˜å±‚æŠ½è±¡</h2><h3>cppcoro</h3><p>æˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹è·¨å¹³å°çš„ cppcoro åº“ <span class="orange">[3]</span>ï¼Œå®ƒæä¾›çš„é«˜å±‚æ¥å£å°±åŒ…å«äº† <code>generator</code>ã€‚å¦‚æœä½¿ç”¨ cppcoroï¼Œæˆ‘ä»¬çš„ <code>fibonacci</code> åç¨‹å¯ä»¥è¿™æ ·å®ç°ï¼š</p><pre><code class="language-c++">#include &lt;cppcoro/generator.hpp&gt;
using cppcoro::generator;

generator&lt;uint64_t&gt; fibonacci()
{
  uint64_t a = 0;
  uint64_t b = 1;
  while (true) {
    co_yield b;
    auto tmp = a;
    a = b;
    b += tmp;
  }
}
</code></pre><p>ä½¿ç”¨ <code>fibonacci</code> ä¹Ÿæ¯”åˆšæ‰çš„ä»£ç è¦æ–¹ä¾¿ï¼š</p><pre><code class="language-c++">for (auto i : fibonacci()) {
  if (i &gt;= 10000) {
    break;
  }
  cout &lt;&lt; i &lt;&lt; endl;
}
</code></pre><p>é™¤äº†ç”Ÿæˆå™¨ï¼Œcppcoro è¿˜æ”¯æŒå¼‚æ­¥ä»»åŠ¡å’Œå¼‚æ­¥ I/Oâ€”â€”é—æ†¾çš„æ˜¯ï¼Œå¼‚æ­¥ I/O ç›®å‰åªæœ‰ Windows å¹³å°ä¸Šæœ‰ï¼Œè¿˜æ²¡äººå®ç° Linux æˆ– macOS ä¸Šçš„æ”¯æŒã€‚</p><h3>MSVC</h3><p>ä½œä¸ºåç¨‹çš„å…ˆè¡Œè€…å’Œ Coroutines TS çš„æå‡ºè€…ï¼Œå¾®è½¯åœ¨åç¨‹ä¸Šåšäº†å¾ˆå¤šå·¥ä½œã€‚ç”Ÿæˆå™¨å½“ç„¶ä¹Ÿåœ¨å…¶ä¸­ï¼š</p><pre><code class="language-c++">#include &lt;experimental/generator&gt;
using std::experimental::generator;

generator&lt;uint64_t&gt; fibonacci()
{
  uint64_t a = 0;
  uint64_t b = 1;
  while (true) {
    co_yield b;
    auto tmp = a;
    a = b;
    b += tmp;
  }
}
</code></pre><p>å¾®è½¯è¿˜æœ‰ä¸€äº›æœ‰è¶£çš„ç§æœ‰æ‰©å±•ã€‚æ¯”å¦‚ï¼ŒMSVC æŠŠæ ‡å‡† C++ çš„ <code>future</code> æ”¹é€ æˆäº† awaitableã€‚ä¸‹é¢çš„ä»£ç åœ¨ MSVC ä¸‹å¯ä»¥ç¼–è¯‘é€šè¿‡ï¼Œç®€å•åœ°å±•ç¤ºäº†åŸºæœ¬ç”¨æ³•ï¼š</p><pre><code class="language-c++">#include &lt;experimental/coroutine&gt;
using namespace std;

future&lt;int&gt; compute_value()
{
  int result = co_await async([] {
    this_thread::sleep_for(1s);
    return 42;
  });
  co_return result;
}

int main()
{
  auto value = compute_value();
  cout &lt;&lt; value.get() &lt;&lt; endl;
}
</code></pre><p>ä»£ç ä¸­æœ‰ä¸€ä¸ªåœ°æ–¹æˆ‘éœ€è¦æé†’ä¸€ä¸‹ï¼šè™½ç„¶ä¸Šé¢ <code>async</code> è¿”å›çš„æ˜¯ <code>future&lt;int&gt;</code>ï¼Œä½† <code>compute_value</code> çš„è°ƒç”¨è€…å¾—åˆ°çš„å¹¶ä¸æ˜¯è¿™ä¸ª <code>future</code>â€”â€”å®ƒå¾—åˆ°çš„æ˜¯å¦å¤–ä¸€ä¸ªç‹¬ç«‹çš„ <code>future</code>ï¼Œå¹¶æœ€ç»ˆç”± <code>co_return</code> æŠŠç»“æœæ•°å€¼å¡«å……äº†è¿›å»ã€‚</p><h2>æœ‰æ ˆåç¨‹å’Œæ— æ ˆåç¨‹</h2><p>æˆ‘ä»¬æœ€åéœ€è¦è¯´ä¸€ä¸‹æœ‰æ ˆï¼ˆstackfulï¼‰åç¨‹å’Œæ— æ ˆï¼ˆstacklessï¼‰åç¨‹çš„åŒºåˆ«ã€‚C++ é‡Œå¾ˆæ—©å°±æœ‰äº†æœ‰æ ˆçš„åç¨‹ï¼Œæ¦‚å¿µä¸Šæ¥è®²ï¼Œæœ‰æ ˆçš„åç¨‹è·Ÿçº¤ç¨‹ã€goroutines åŸºæœ¬æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œéƒ½æ˜¯ç”±ç”¨æˆ·è‡ªè¡Œè°ƒåº¦çš„ã€æ“ä½œç³»ç»Ÿä¹‹å¤–çš„è¿è¡Œå•å…ƒã€‚æ¯ä¸ªè¿™æ ·çš„è¿è¡Œå•å…ƒéƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„æ ˆç©ºé—´ï¼Œç¼ºç‚¹å½“ç„¶å°±æ˜¯æ ˆçš„ç©ºé—´å ç”¨å’Œåˆ‡æ¢æ ˆçš„å¼€é”€äº†ã€‚è€Œæ— æ ˆçš„åç¨‹è‡ªå·±æ²¡æœ‰ç‹¬ç«‹çš„æ ˆç©ºé—´ï¼Œæ¯ä¸ªåç¨‹åªéœ€è¦ä¸€ä¸ªå¾ˆå°çš„æ ˆå¸§ï¼Œç©ºé—´å ç”¨å°ï¼Œä¹Ÿæ²¡æœ‰æ ˆçš„åˆ‡æ¢å¼€é”€ã€‚</p><p>C++20 çš„åç¨‹æ˜¯æ— æ ˆçš„ã€‚éƒ¨åˆ†åŸå› æ˜¯æœ‰æ ˆçš„åç¨‹å¯ä»¥ä½¿ç”¨çº¯åº“æ–¹å¼å®ç°ï¼Œè€Œæ— æ ˆçš„åç¨‹éœ€è¦ä¸€ç‚¹ç¼–è¯‘å™¨é­”æ³•å¸®å¿™ã€‚æ¯•ç«Ÿï¼Œåç¨‹é‡Œé¢çš„å˜é‡éƒ½æ˜¯è¦æ”¾åˆ°å †ä¸Šè€Œä¸æ˜¯æ ˆä¸Šçš„ã€‚</p><p>ä¸€ä¸ªç®€å•çš„æ— æ ˆåç¨‹è°ƒç”¨çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static001.geekbang.org/resource/image/e3/66/e35d2b262c741acf40d69eedc6a5ad66.png" alt=""></p><p>å¯ä»¥çœ‹åˆ°ï¼Œåç¨‹ C æœ¬èº«çš„æœ¬åœ°å˜é‡ä¸å ç”¨æ ˆï¼Œä½†å½“å®ƒè°ƒç”¨å…¶ä»–å‡½æ•°æ—¶ï¼Œå®ƒä¼šä½¿ç”¨çº¿ç¨‹åŸå…ˆçš„æ ˆç©ºé—´ã€‚åœ¨ä¸Šé¢çš„å‡½æ•° D çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œåç¨‹æ˜¯ä¸å¯ä»¥æŒ‚èµ·çš„â€”â€”å¦‚æœæ§åˆ¶å›åˆ° B ç»§ç»­ï¼ŒB å¯èƒ½ä¼šä½¿ç”¨ç›®å‰å·²ç»è¢« D ä½¿ç”¨çš„æ ˆç©ºé—´ï¼</p><p>å› æ­¤ï¼Œæ— æ ˆçš„åç¨‹ç‰ºç‰²äº†ä¸€å®šçš„çµæ´»æ€§ï¼Œæ¢æ¥äº†ç©ºé—´çš„èŠ‚çœå’Œæ€§èƒ½ã€‚æœ‰æ ˆçš„åç¨‹ä½ å¯èƒ½èµ·å‡ åƒä¸ªå°±å ç”¨ä¸å°‘å†…å­˜ç©ºé—´ï¼Œè€Œæ— æ ˆçš„åç¨‹å¯ä»¥è½»è½»æ¾æ¾èµ·åˆ°äº¿çº§â€”â€”æ¯•ç«Ÿï¼Œç»´æŒåŸºæœ¬çŠ¶æ€çš„å¼€é”€æˆ‘å®æµ‹ä¸‹æ¥åªæœ‰ä¸€ç™¾å­—èŠ‚å·¦å³ã€‚</p><p>åè¿‡æ¥ï¼Œå¦‚æœæ— æ ˆçš„åç¨‹ä¸æ»¡è¶³éœ€è¦â€”â€”æ¯”å¦‚ï¼Œä½ çš„åç¨‹é‡Œéœ€è¦æœ‰é€’å½’è°ƒç”¨ï¼Œå¹¶åœ¨æ·±å±‚æŒ‚èµ·â€”â€”ä½ å°±ä¸å¾—ä¸å¯»æ‰¾ä¸€ä¸ªæœ‰æ ˆçš„åç¨‹çš„è§£å†³æ–¹æ¡ˆã€‚ç›®å‰å·²ç»æœ‰ä¸€äº›æˆç†Ÿçš„æ–¹æ¡ˆï¼Œæ¯”å¦‚ Boost.Coroutine2 <span class="orange">[4]</span>ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºå¦‚ä½•åœ¨ Boost.Coroutine2 é‡Œå®ç° <code>fibonacci</code>ï¼Œè®©ä½ æ„Ÿå—ä¸€ç‚¹ç‚¹å°åŒºåˆ«ï¼š</p><pre><code class="language-c++">#include &lt;iostream&gt;
#include &lt;stdint.h&gt;
#include &lt;boost/coroutine2/all.hpp&gt;

typedef boost::coroutines2::
  coroutine&lt;const uint64_t&gt;
    coro_t;

void fibonacci(
  coro_t::push_type&amp; yield)
{
  uint64_t a = 0;
  uint64_t b = 1;
  while (true) {
    yield(b);
    auto tmp = a;
    a = b;
    b += tmp;
  }
}

int main()
{
  for (auto i : coro_t::pull_type(
         boost::coroutines2::
           fixedsize_stack(),
         fibonacci)) {
    if (i &gt;= 10000) {
      break;
    }
    std::cout &lt;&lt; i &lt;&lt; std::endl;
  }
}
</code></pre><h2>ç¼–è¯‘å™¨æ”¯æŒ</h2><p>å‰é¢æåˆ°äº†ï¼ŒMSVC å’Œ Clang ç›®å‰æ”¯æŒåç¨‹ã€‚ä¸è¿‡ï¼Œå®ƒä»¬éƒ½éœ€è¦ç‰¹æ®Šçš„å‘½ä»¤è¡Œé€‰é¡¹æ¥å¼€å¯åç¨‹æ”¯æŒï¼š</p><ul>
<li>MSVC éœ€è¦ <code>/await</code> å‘½ä»¤è¡Œé€‰é¡¹</li>
<li>Clang éœ€è¦ <code>-fcoroutines-ts</code> å‘½ä»¤è¡Œé€‰é¡¹</li>
</ul><p>ä¸ºäº†æ»¡è¶³ä½¿ç”¨ CMake çš„åŒå­¦çš„è¦æ±‚ï¼Œä¹Ÿä¸ºäº†æ–¹ä¾¿å¤§å®¶ç¼–è¯‘ï¼Œæˆ‘æŠŠç¤ºä¾‹ä»£ç æ”¾åˆ°äº† GitHub ä¸Šï¼š</p><p><a href="https://github.com/adah1972/geek_time_cpp">https://github.com/adah1972/geek_time_cpp</a></p><p>ç¬¬ä¸€æ¬¡æˆ‘åªæ”¾äº†ç¬¬ 30 è®²çš„ä»£ç ï¼Œä½†æˆ‘ä¼šæŠŠå…¶ä»–çš„ä»£ç é™†ç»­è¡¥ä¸Šã€‚</p><h2>å†…å®¹å°ç»“</h2><p>æœ¬è®²è®¨è®ºäº† C++20 é‡Œçš„ç¬¬ä¸‰ä¸ªé‡è¦ç‰¹æ€§ï¼šåç¨‹ã€‚åç¨‹ä»ç„¶å¾ˆæ–°ï¼Œä½†å®ƒçš„é‡è¦æ€§æ˜¯æ¯‹åº¸ç½®ç–‘çš„â€”â€”å°¤å…¶åœ¨ç”Ÿæˆå™¨å’Œå¼‚æ­¥ I/O ä¸Šã€‚</p><h2>è¯¾åæ€è€ƒ</h2><p>è¯·ä»”ç»†æ¯”è¾ƒç¬¬ä¸€ä¸ª <code>fibonacci</code> çš„ C++ å®ç°å’Œæœ€åä½¿ç”¨ <code>generator</code> çš„ <code>fibonacci</code> çš„å®ç°ï¼Œä½“ä¼šåç¨‹ä»£ç å¦‚æœè‡ªè¡Œç”¨çŠ¶æ€æœºçš„æ–¹å¼æ¥å®ç°ï¼Œæ˜¯ä¸€ä»¶å¤šéº»çƒ¦çš„äº‹æƒ…ã€‚</p><p>å¦‚æœä½ å¯¹åç¨‹æœ‰å…´è¶£ï¼Œå¯ä»¥æŸ¥çœ‹å‚è€ƒèµ„æ–™ <span class="orange">[5]</span>ï¼Œé‡Œé¢æä¾›äº†ä¸€äº›è¾ƒä¸ºæ·±å…¥çš„åŸç†ä»‹ç»ã€‚</p><h2><span class="reference">å‚è€ƒèµ„æ–™ </span></h2><p><span class="reference">[1] ç»´åŸºç™¾ç§‘, â€œåç¨‹â€. <a href="https://zh.wikipedia.org/zh-cn/%E5%8D%8F%E7%A8%8B">https://zh.wikipedia.org/zh-cn/åç¨‹</a> </span></p><p><span class="reference">[2] Gor Nishanov, â€œWorking draft, C++ extensions for coroutinesâ€. <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/n4775.pdf">http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/n4775.pdf</a> </span></p><p><span class="reference">[3] Lewis Baker, CppCoro. <a href="https://github.com/lewissbaker/cppcoro">https://github.com/lewissbaker/cppcoro</a> </span></p><p><span class="reference">[4] Oliver Kowalke, Boost.Coroutine2. <a href="https://www.boost.org/doc/libs/release/libs/coroutine2/doc/html/index.html">https://www.boost.org/doc/libs/release/libs/coroutine2/doc/html/index.html</a> </span></p><p><span class="reference">[5] Dawid Pilarski, â€œCoroutines introductionâ€. <a href="https://blog.panicsoftware.com/coroutines-introduction/">https://blog.panicsoftware.com/coroutines-introduction/</a> </span></p><h2>ç²¾é€‰ç•™è¨€ï¼š</h2>
        <ul>
        
<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            æ™šé£Â·å’Œç…¦  2020-02-11 02:20:14
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            è€å¸ˆï¼Œmap&lt;int, int&gt;().swap(map1);<br>è¿™ä¸ªè¯­å¥ä¸ºä»€ä¹ˆä¸èƒ½è¾¾åˆ°çœŸæ­£é‡Šæ”¾map1å†…å­˜çš„æ•ˆæœå‘¢ï¼Ÿå¿…é¡»å¾—ç”¨malloc_trim 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;        line-height:1.2">ä½œè€…å›å¤2020-02-11 13:38:32</div>
    <div style="color:#353535;font-weight:400;white-space:normal;        word-break:break-all;line-height:1.6">å…ˆè¯´æ˜¯ä¸æ˜¯ï¼Œç„¶åæ‰è°ˆå¾—ä¸Šä¸ºä»€ä¹ˆã€‚<br><br>åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½æ²¡æœ‰å¿…è¦é‚£ä¹ˆåšã€‚æˆ‘ä»æ¥æ²¡åœ¨ä»£ç é‡Œå†™è¿‡ malloc_trimã€‚<br><br>åœ¨æœ‰è™šæ‹Ÿå†…å­˜çš„ä¸–ç•Œé‡Œï¼Œæˆ‘çœ‹ä¸å‡ºè°ƒç”¨ malloc_trim çš„å¿…è¦æ€§ã€‚æ“ä½œç³»ç»Ÿè‡ªå·±èƒ½ç®¡å¥½ã€‚<br><br>å¦‚æœåµŒå…¥å¼å¼€å‘ï¼Œæ²¡æœ‰è™šæ‹Ÿå†…å­˜ï¼Œä½ ç”¨ malloc_trim ä¹Ÿä¸è§å¾—æœ‰ç”¨ã€‚å› ä¸ºä¸€æ—¦å †çš„å°¾éƒ¨æœ‰åˆ†é…ï¼Œä½ å¹¶ä¸èƒ½é‡Šæ”¾å†…å­˜å›æ“ä½œç³»ç»Ÿã€‚<br><br>è€Œä¸”ï¼Œä½ ä¸ºä»€ä¹ˆè¦è¿˜å†…å­˜ç»™æ“ä½œç³»ç»Ÿï¼Ÿä»¥åä½ ä¸ç”¨äº†å—ï¼Ÿæ˜¯ç¨‹åºè¦é€€å‡ºäº†å—ï¼Ÿå¦‚æœç¨‹åºè¦é€€å‡ºï¼Œæœ¬æ¥å ç”¨çš„èµ„æºå°±ä¼šè¢«é‡Šæ”¾æ‰ã€‚å¦‚æœç¨‹åºä¸é€€å‡ºï¼Œè¿›ç¨‹ç®¡å¥½è‡ªå·±çš„äº‹ï¼Œä¸‹æ¬¡åˆ†é…èƒ½ä¸éº»çƒ¦æ“ä½œç³»ç»Ÿå°±ä¸éº»çƒ¦æ“ä½œç³»ç»Ÿï¼Œåº”è¯¥åè€Œæ›´å¥½ã€‚<br><br>æˆ‘çš„ä¸ªäººè§è§£ï¼Œè°å‘Šè¯‰ä½ è¿™å¥è¯çš„ï¼ŒåŸºæœ¬ä¸Šå¹¶ä¸çœŸæ‡‚åº”ç”¨å¼€å‘ï¼Œåªæ˜¯å­¦äº†ç‚¹æ ¸å¿ƒè°ƒç”¨çš„çŸ¥è¯†ï¼Œåœ¨çå–å¼„è€Œå·²ã€‚</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            Vackine  2020-02-10 09:41:27
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            æ„Ÿè§‰è·Ÿpythoné‡Œé¢çš„asyncçš„æ–°çš„æ ‡å‡†åº“å¥½åƒï¼Œæ˜¯çœŸçš„æœ‰æ€§èƒ½ä¸Šçš„æå‡ä¹ˆï¼Œè¿˜æ˜¯åªæ˜¯ç¼–ç¨‹é­”æ³•ï¼Ÿ 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;        line-height:1.2">ä½œè€…å›å¤2020-02-10 19:58:45</div>
    <div style="color:#353535;font-weight:400;white-space:normal;        word-break:break-all;line-height:1.6">ç¼–ç¨‹é­”æ³•å’Œæ€§èƒ½æå‡æœ‰çŸ›ç›¾ä¹ˆï¼ŸğŸ¤ª<br><br>ä¸¥è‚ƒç‚¹ï¼Œåç¨‹ä¸æ˜¯ä¸ºäº†æé«˜ä»£ç æ€§èƒ½ï¼Œè€Œæ˜¯ä¸ºäº†æé«˜ç¨‹åºå‘˜çš„ç”Ÿäº§ç‡ã€‚ä»è¿™ç‚¹ä¸Šæ¥è¯´ï¼Œåç¨‹ä»ç„¶æ˜¯ä¸€ç§ç¼–è¯‘å™¨çš„é»‘é­”æ³•ã€‚<br><br>è·Ÿæ‰‹å†™æ¯”èµ·æ¥ï¼Œæ²¡æœ‰æ€§èƒ½çš„æå‡ã€‚å°±å¦‚åŒé™¤äº†æå°‘æ•°çš„æƒ…å†µï¼ˆæ¯”å¦‚æ³›å‹å…è®¸å†…è”å¯¼è‡´C++çš„æ’åºæ¯”Cçš„qsortå¿«ï¼‰ï¼ŒC++ä»£ç ä¸ä¼šæ¯”Cä»£ç æ€§èƒ½æ›´é«˜ã€‚</div>
</div>
            
    </div>
</li>
            </ul>
</div>
</body>
</html>